<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>State-Space models in the mvgam package • mvgam</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="State-Space models in the mvgam package">
<meta property="og:description" content="mvgam">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in the mvgam package</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>State-Space models in the mvgam package</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2023-09-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/trend_formulas.Rmd" class="external-link"><code>vignettes/trend_formulas.Rmd</code></a></small>
      <div class="d-none name"><code>trend_formulas.Rmd</code></div>
    </div>

    
    
<p>The purpose of this vignette is to show how the <code>mvgam</code>
package can be used to fit and interrogate State-Space models with
nonlinear effects.</p>
<div class="section level2">
<h2 id="state-space-models">State-Space Models<a class="anchor" aria-label="anchor" href="#state-space-models"></a>
</h2>
<div class="figure">
<img src="SS_model.svg" style="width:85.0%" alt=""><p class="caption">Illustration of a basic State-Space model, which
assumes that a latent dynamic <em>process</em> (X) can evolve
independently from the way we take <em>observations</em> (Y) of that
process</p>
</div>
<p><br></p>
<p>State-Space models allow us to separately make inferences about the
underlying dynamic <em>process model</em> that we are interested in
(i.e. the evolution of a time series or a collection of time series) and
the <em>observation model</em> (i.e. the way that we survey / measure
this underlying process). This is extremely useful in ecology because
our observations are always imperfect / noisy measurements of the thing
we are interested in measuring. It is also helpful because we often know
that some covariates will impact our ability to measure accurately
(i.e. we cannot take accurate counts of rodents if there is a
thunderstorm happening) while other covariate impact the underlying
process (it is highly unlikely that rodent abundance responds to one
storm, but instead probably responds to longer-term weather and climate
variation). A State-Space model allows us to model both components in a
single unified modelling framework. A major advantage of
<code>mvgam</code> is that it can include nonlinear effects and random
effects in BOTH model components while also capturing dynamic
processes.</p>
<div class="section level3">
<h3 id="lake-washington-plankton-data">Lake Washington plankton data<a class="anchor" aria-label="anchor" href="#lake-washington-plankton-data"></a>
</h3>
<p>The data we will use to illustrate how we can fit State-Space models
in <code>mvgam</code> are from a long-term monitoring study of plankton
counts (cells per mL) taken from Lake Washington in Washington, USA. The
data are available as part of the <code>MARSS</code> package and can be
downloaded using the following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/atsa-es/MARSS/raw/master/data/lakeWAplankton.rda'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will work with five different groups of plankton:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Greens'</span>, <span class="st">'Bluegreens'</span>, <span class="st">'Diatoms'</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span><span class="op">)</span></span></code></pre></div>
<p>As usual, preparing the data into the correct format for
<code>mvgam</code> modelling takes a little bit of wrangling in
<code>dplyr</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># loop across each plankton group to create the long datframe</span></span>
<span><span class="va">plankton_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">outcomes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># create a group-specific dataframe with counts labelled 'y'</span></span>
<span>  <span class="co"># and the group name in the 'series' variable</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">'Year'</span><span class="op">]</span>,</span>
<span>             month <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">'Month'</span><span class="op">]</span>,</span>
<span>             y <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,</span>
<span>             series <span class="op">=</span> <span class="va">x</span>,</span>
<span>             temp <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">'Temp'</span><span class="op">]</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># change the 'series' label to a factor</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># filter to only include some years in the data</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1965</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">&lt;</span> <span class="fl">1975</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># z-score the counts so they are approximately standard normal</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># add the time indicator</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Inspect the data structure</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">##    year month       y series       temp  time</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.542</span>  Greens      -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.344</span>  Bluegreens  -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.076</span><span style="color: #BB0000; text-decoration: underline;">8</span> Diatoms     -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">1.52</span>   Unicells    -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.491</span>  Other.algae -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>  <span style="text-decoration: underline;">1</span>965     2 <span style="color: #BB0000;">NA</span>      Greens      -<span style="color: #BB0000;">1.32</span>     2</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 600</span></span>
<span><span class="co">## Columns: 6</span></span>
<span><span class="co">## $ year   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 196…</span></span>
<span><span class="co">## $ month  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, …</span></span>
<span><span class="co">## $ y      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.54241769, -0.34410776, -0.07684901, -1.52243490, -0.49055442…</span></span>
<span><span class="co">## $ series <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> Greens, Bluegreens, Diatoms, Unicells, Other.algae, Greens, Blu…</span></span>
<span><span class="co">## $ temp   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.2306562, -1.2306562, -1.2306562, -1.2306562, -1.2306562, -1.…</span></span>
<span><span class="co">## $ time   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, …</span></span></code></pre>
<p>Note that we have z-scored the counts in this example as that will
make it easier to specify priors (though this is not completely
necessary; it is often better to build a model that respects the
properties of the actual outcome variables)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plankton_data</span>, series <span class="op">=</span> <span class="st">'all'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-6-1.png" width="60%" style="display: block; margin: auto;"><img src="trend_formulas_files/figure-html/unnamed-chunk-6-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>As usual, check the data for <code>NA</code>s:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span><span class="op">)</span>, axes <span class="op">=</span> <span class="cn">F</span>,</span>
<span>      col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'grey80'</span>, <span class="st">'darkred'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-7-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We have some missing observations, but of course this isn’t an issue
for modelling in <code>mvgam</code>. A useful property to understand
about these counts is that they tend to be highly seasonal. Below are
some plots of z-scored counts against the z-scored temperature
measurements in the lake for each month:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">'Other.algae'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">'z-score'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'Temperature (black) vs Other algae (red)'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-8-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">'Diatoms'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">'z-score'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'Temperature (black) vs Diatoms (red)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-9-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">'Greens'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">'z-score'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'Temperature (black) vs Greens (red)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-10-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We will have to try and capture this seasonality in our process
model, which should be easy to do given the flexibility of GAMs. Next we
will split the data into training and testing splits:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_train</span> <span class="op">&lt;-</span> <span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">112</span><span class="op">)</span></span>
<span><span class="va">plankton_test</span> <span class="op">&lt;-</span> <span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">112</span><span class="op">)</span></span></code></pre></div>
<p>Now time to fit some models. This requires a bit of thinking about
how we can best tackle the seasonal variation and the likely dependence
structure in the data. These algae are interacting as part of a complex
system within the same lake, so we certainly expect there to be some
lagged cross-dependencies underling their dynamics. But if we do not
capture the seasonal variation, our multivariate dynamic model will be
forced to try and capture it, which could lead to poor convergence and
unstable results (we could feasibly capture cyclic dynamics with a more
complex multi-species Lotka-Volterra model, but ordinary differential
equation approaches are beyond the scope of this workshop).</p>
</div>
<div class="section level3">
<h3 id="capturing-seasonality">Capturing seasonality<a class="anchor" aria-label="anchor" href="#capturing-seasonality"></a>
</h3>
<p>First we will fit a model that does not include a dynamic component,
just to see if it can reproduce the seasonal variation in the
observations. This model builds from our hierarchical GAMs above by
introducing hierarchical multidimensional smooths. It includes a
“global” tensor product of the <code>month</code> and <code>temp</code>
variables, capturing our expectation that algal seasonality responds to
temperature variation. But this response should depend on when in the
year these temperatures are recorded (i.e. a response to warm
temperatures in Spring should be different to a response to warm
temperatures in Autumn). The model also fits series-specific deviation
smooths (i.e. one tensor product per series) to capture how each algal
group’s seasonality differs from the overall “global” seasonality. Note
that we do not include series-specific intercepts in this model because
each series was z-scored to have a mean of 0.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">notrend_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> </span>
<span>                       <span class="co"># tensor of temp and month to capture</span></span>
<span>                       <span class="co"># "global" seasonality</span></span>
<span>                       <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                       </span>
<span>                       <span class="co"># series-specific deviation tensor products</span></span>
<span>                       <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span>,</span>
<span>                     family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>                     trend_model <span class="op">=</span> <span class="st">'None'</span><span class="op">)</span></span></code></pre></div>
<p>The “global” tensor product smooth function can be quickly
visualized:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-13-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can then plot the deviation smooths for each algal group to see
how they vary from the “global” pattern:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-14-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-15-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-16-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-17-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-18-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>These multidimensional smooths have done a good job of capturing the
seasonal variation in our observations:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-19-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-20-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-21-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-22-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-23-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="multiseries-dynamics">Multiseries dynamics<a class="anchor" aria-label="anchor" href="#multiseries-dynamics"></a>
</h3>
<p>The basic model gives us confidence that we can capture the seasonal
variation in the observations. But the model has not captured the
remaining temporal dynamics, which is obvious when we inspect Dunn-Smyth
residuals for each series:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-24-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-25-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-26-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-27-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-28-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Now it is time to get into multivariate State-Space models. We will
fit two models that can both incorporate lagged cross-dependencies in
the latent process models. The first model assumes that the process
errors operate independnetly from one another, while the second assumes
that there may be contemporaneous correlations in the process errors.
Both models include a Vector Autoregressive component for the process
means, and so both can model complex community dynamics. The models can
be described mathematically as follows:</p>
<p><span class="math display">\[\begin{align*}
\boldsymbol{count}_t &amp; \sim \text{Normal}(\mu_{obs[t]},
\sigma_{obs}) \\
\mu_{obs[t]} &amp; = \alpha + process_t \\
\sigma_{obs} &amp; \sim \text{Uniform}(0.1, 1) \\
process_t &amp; \sim \text{MVNormal}(\mu_{process[t]}, \Sigma_{process})
\\
\mu_{process[t]} &amp; = VAR * process_{t-1} +
f_{global}(\boldsymbol{month},\boldsymbol{temp})_t +
f_{series}(\boldsymbol{month},\boldsymbol{temp})_t \\
f_{global}(\boldsymbol{month},\boldsymbol{temp}) &amp; =
\sum_{k=1}^{K}b_{global} * \beta_{global} \\
f_{series}(\boldsymbol{month},\boldsymbol{temp}) &amp; =
\sum_{k=1}^{K}b_{series} * \beta_{series} \\
VAR &amp; \sim \text{Normal}(0, 1) \\
\Sigma_{process} &amp; = \text{diag}(\sigma_{process}) * \text{R} *
\text{diag}(\sigma_{process}) \\
\text{R} &amp; \sim \text{LKJcorr}(2) \end{align*}\]</span></p>
<p>Here you can see that we assume independent observation processes
(there is no covariance structure in the observation errors <span class="math inline">\(\sigma_{obs}\)</span>) but there is a lot going on
in the underlying process model. This component has a Vector
Autoregressive part (where the process mean at time <span class="math inline">\(t\)</span> <span class="math inline">\((\mu_{process[t]})\)</span>) is a vector that
evolves as a function of where the vector-valued process model was at
time <span class="math inline">\(t-1\)</span>. The <span class="math inline">\(VAR\)</span> matrix captures these dynamics with
self-dependencies on the diagonal and possibly assymetric
cross-dependencies on the off-diagonals. The contemporaneous process
errors are captured by <span class="math inline">\(\Sigma_{process}\)</span>, which can be
constrained so that process errors are independent (i.e. setting the
off-diagonals to 0) or can be fully parameterized using a Cholesky
decomposition (using <code>Stan</code>’s <span class="math inline">\(LKJcorr\)</span> distribution to place a prior on
the strength of inter-species correlations).</p>
<p><br> Ok that was a lot to take in. Let’s fit some models to try and
inspect what is going on and what they assume. But first, we need to
update <code>mvgam</code>’s default priors for the observation errors.
By default, <code>mvgam</code> uses a fairly wide Student-T prior on
this parameter because the package doesn’t know what range the
observations will be on. But our observations are z-scored and so we do
not expect very large observation errors. However, we also do not expect
very small observation errors. So let’s update the prior for this
parameter. In doing so, you will get to see how the formula for the
latent process (i.e. trend) model is used in <code>mvgam</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with uncorrelated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># update the sigma_obs prior so that it avoids very small</span></span>
<span><span class="co"># and very large values that are nonsensical</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">prior</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"sigma_obs ~ uniform(0.1, 1);"</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_lowerbound</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_upperbound</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>Note that if you already know the names of parameters for which you’d
like to modify the priors, you can more quickly make edits using
<code>brms</code> functionality:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu">prior</span><span class="op">(</span><span class="fu">uniform</span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma_obs</span>, lb <span class="op">=</span> <span class="fl">0.1</span>, ub <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Now we can fit the first model, which assumes that process errors are
contemporaneously uncorrelated</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span>  </span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with uncorrelated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>  </span>
<span>  <span class="co"># include the updated priors</span></span>
<span>  priors <span class="op">=</span> <span class="va">priors</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-ss-models">Inspecting SS models<a class="anchor" aria-label="anchor" href="#inspecting-ss-models"></a>
</h3>
<p>This model’s summary is a bit different to other <code>mvgam</code>
summaries. It separates parameters based on whether they belong to the
observation model or to the latent process model. This is because we may
often have covariates that impact the observations but not the latent
process, so we can have fairly complex models for each component. You
will notice that some parameters have not fully converged, particularly
for the VAR coefficients (called <code>A</code> in the output) and for
the process errors (<code>Sigma</code>)</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">var_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## GAM observation formula:</span></span>
<span><span class="co">## y ~ 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM process formula:</span></span>
<span><span class="co">## ~te(temp, month, k = c(4, 4)) + te(temp, month, k = c(4, 4), </span></span>
<span><span class="co">##     by = trend)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Family:</span></span>
<span><span class="co">## gaussian</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Link function:</span></span>
<span><span class="co">## identity</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Trend model:</span></span>
<span><span class="co">## VAR1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## N process models:</span></span>
<span><span class="co">## 5 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## N series:</span></span>
<span><span class="co">## 5 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## N timepoints:</span></span>
<span><span class="co">## 112 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Status:</span></span>
<span><span class="co">## Fitted using Stan </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Observation error parameter estimates:</span></span>
<span><span class="co">##                   2.5%       50%     97.5% Rhat n.eff</span></span>
<span><span class="co">## sigma_obs[1] 0.1074801 0.1868650 0.2901048 1.03   153</span></span>
<span><span class="co">## sigma_obs[2] 0.1232430 0.3062065 0.5005204 1.05    74</span></span>
<span><span class="co">## sigma_obs[3] 0.7371849 0.8777065 0.9877566 1.01   459</span></span>
<span><span class="co">## sigma_obs[4] 0.1281301 0.2915020 0.4471391 1.06    75</span></span>
<span><span class="co">## sigma_obs[5] 0.2233128 0.4238945 0.5581242 1.03   115</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM observation model coefficient (beta) estimates:</span></span>
<span><span class="co">##                   2.5%         50%      97.5% Rhat n.eff</span></span>
<span><span class="co">## (Intercept) -0.1454303 -0.04713185 0.04666873 1.02   185</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process model VAR parameter estimates:</span></span>
<span><span class="co">##               2.5%          50%       97.5% Rhat n.eff</span></span>
<span><span class="co">## A[1,1]  0.10804172  0.403263000  0.68063297 1.00   434</span></span>
<span><span class="co">## A[1,2] -0.98452670  0.549097500  1.63943300 1.10    40</span></span>
<span><span class="co">## A[1,3] -0.52451945 -0.232090000 -0.01026316 1.01   296</span></span>
<span><span class="co">## A[1,4] -0.21754273  0.050809350  0.33690087 1.03    93</span></span>
<span><span class="co">## A[1,5] -0.04992678  0.251246000  0.72086575 1.02   249</span></span>
<span><span class="co">## A[2,1] -0.33255717 -0.063480600  0.15658805 1.04    87</span></span>
<span><span class="co">## A[2,2]  0.10919193  0.734683500  1.01580325 1.03   107</span></span>
<span><span class="co">## A[2,3] -0.17619895 -0.005474020  0.11166490 1.01   266</span></span>
<span><span class="co">## A[2,4] -0.11451565  0.000386573  0.21260117 1.04    91</span></span>
<span><span class="co">## A[2,5] -0.17546047  0.004058010  0.23778547 1.02   197</span></span>
<span><span class="co">## A[3,1] -0.42930533 -0.164388000  0.01389181 1.02   217</span></span>
<span><span class="co">## A[3,2] -0.36112507  0.078792950  0.57698535 1.01   328</span></span>
<span><span class="co">## A[3,3]  0.57422295  0.747823500  0.88827908 1.00   303</span></span>
<span><span class="co">## A[3,4] -0.07757434  0.056335300  0.20604142 1.00   458</span></span>
<span><span class="co">## A[3,5] -0.02323283  0.157009000  0.44612817 1.00   284</span></span>
<span><span class="co">## A[4,1] -0.57696972 -0.204785500  0.06126757 1.02   255</span></span>
<span><span class="co">## A[4,2] -0.67535428  0.619014000  1.88414825 1.09    44</span></span>
<span><span class="co">## A[4,3] -0.47006257 -0.175753000  0.06427537 1.02   289</span></span>
<span><span class="co">## A[4,4]  0.36969488  0.680193000  0.90528038 1.02   129</span></span>
<span><span class="co">## A[4,5] -0.13761870  0.228728000  0.74021613 1.03   203</span></span>
<span><span class="co">## A[5,1] -0.38163103 -0.096253650  0.14350830 1.01   300</span></span>
<span><span class="co">## A[5,2] -0.51355090  0.235055000  1.10377250 1.05    63</span></span>
<span><span class="co">## A[5,3] -0.10457225  0.063459900  0.28475545 1.01   257</span></span>
<span><span class="co">## A[5,4] -0.26504730 -0.053836750  0.11540252 1.02   166</span></span>
<span><span class="co">## A[5,5]  0.41234595  0.734678000  0.95538637 1.03   161</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process error parameter estimates:</span></span>
<span><span class="co">##                  2.5%       50%     97.5% Rhat n.eff</span></span>
<span><span class="co">## Sigma[1,1] 0.05288037 0.1701345 0.3259489 1.06    77</span></span>
<span><span class="co">## Sigma[1,2] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[1,3] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[1,4] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[1,5] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,1] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,2] 0.01021271 0.0345773 0.1413630 1.09    50</span></span>
<span><span class="co">## Sigma[2,3] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,4] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,5] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,1] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,2] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,3] 0.07360951 0.1332825 0.2031740 1.01   303</span></span>
<span><span class="co">## Sigma[3,4] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,5] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,1] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,2] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,3] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,4] 0.09428811 0.2093545 0.3608786 1.05   124</span></span>
<span><span class="co">## Sigma[4,5] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,1] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,2] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,3] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,4] 0.00000000 0.0000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,5] 0.04459768 0.1091940 0.2770167 1.03   114</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM process model coefficient (beta) estimates:</span></span>
<span><span class="co">##                                            2.5%          50%       97.5% Rhat</span></span>
<span><span class="co">## te(temp,month).1_trend              -0.73847505 -0.217160000  0.30233200 1.00</span></span>
<span><span class="co">## te(temp,month).2_trend              -0.72378105 -0.031489700  0.81944155 1.00</span></span>
<span><span class="co">## te(temp,month).3_trend              -0.99018958 -0.318722500  0.33118392 1.00</span></span>
<span><span class="co">## te(temp,month).4_trend              -0.59751997 -0.228054500  0.12703725 1.01</span></span>
<span><span class="co">## te(temp,month).5_trend              -0.04888301  0.303813500  0.75505102 1.01</span></span>
<span><span class="co">## te(temp,month).6_trend              -0.34884415  0.063235150  0.60757315 1.01</span></span>
<span><span class="co">## te(temp,month).7_trend              -0.54982225 -0.213960500  0.08914538 1.01</span></span>
<span><span class="co">## te(temp,month).8_trend              -0.84599675 -0.193592500  0.55231295 1.00</span></span>
<span><span class="co">## te(temp,month).9_trend               0.06901501  0.407911000  0.76266737 1.01</span></span>
<span><span class="co">## te(temp,month).10_trend              0.25489585  0.673990500  1.14147875 1.01</span></span>
<span><span class="co">## te(temp,month).11_trend             -0.75155495 -0.187905500  0.38067945 1.01</span></span>
<span><span class="co">## te(temp,month).12_trend             -0.99313960 -0.220809000  0.95214500 1.00</span></span>
<span><span class="co">## te(temp,month).13_trend             -0.39012798  0.138990500  0.77400980 1.01</span></span>
<span><span class="co">## te(temp,month).14_trend              0.14717373  0.572497000  0.99305962 1.00</span></span>
<span><span class="co">## te(temp,month).15_trend             -1.14550100 -0.127863000  1.01974075 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.1_trend  -0.20664415  0.710738500  1.60585600 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.2_trend  -0.88569682  0.528135000  1.93839850 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.3_trend  -1.22823100 -0.269062000  1.05514700 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.4_trend  -0.49173900  0.035305300  0.69182950 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.5_trend   0.54813672  1.188080000  1.80269525 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.6_trend  -0.84490125  0.089129150  0.93543392 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.7_trend  -0.67638895 -0.249140500  0.24562335 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.8_trend  -0.85728975  0.012408400  1.82351250 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.9_trend   0.39284527  1.111980000  1.67484100 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.10_trend -1.11257525 -0.457721000  0.18799895 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.11_trend -1.47777700 -0.058745750  0.67032462 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.12_trend -1.12762975 -0.046399200  2.69783750 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.13_trend -0.69479815  0.451419000  1.58814450 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.14_trend -1.40288750 -0.753952000 -0.08423565 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.15_trend -2.62059875  0.383467500  1.76616225 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend2.1_trend  -0.39119467  0.123719000  0.75612215 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.2_trend  -0.44648723  0.103178500  0.75055677 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.3_trend  -0.56423067  0.019929300  0.64505105 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.4_trend  -0.73715500 -0.159689000  0.24601597 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.5_trend  -0.48048880 -0.012879850  0.45262630 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.6_trend  -0.37261460  0.014848000  0.41421147 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.7_trend  -0.50696670 -0.098178100  0.28053640 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend2.8_trend  -0.71988400 -0.110334500  0.48902585 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.9_trend  -0.39289775  0.004745790  0.36542607 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.10_trend -0.58078363 -0.046292850  0.43276630 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend2.11_trend -0.56842875 -0.075804100  0.38396097 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.12_trend -0.64003285  0.007752655  0.76260242 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.13_trend -0.30993465  0.141661500  0.77099047 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.14_trend -0.24481490  0.149837000  0.74425537 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.15_trend -0.67472292  0.054351650  0.95500030 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.1_trend  -0.60060703 -0.053892650  0.42752412 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend3.2_trend  -0.83176910 -0.079367850  0.44767295 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend3.3_trend  -0.42831993  0.095105400  0.78585445 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.4_trend  -0.40113098  0.002467455  0.39896530 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.5_trend  -0.75936307 -0.252116000  0.11675142 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.6_trend  -0.55681817 -0.087859600  0.22330807 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend3.7_trend  -0.13305310  0.179629500  0.54050717 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.8_trend  -0.70229785  0.011961800  0.61841327 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.9_trend  -0.73199477 -0.252181000  0.09112068 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend3.10_trend -0.51858380 -0.036862900  0.39696880 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.11_trend -0.17007635  0.216151500  0.71874605 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.12_trend -0.81855652  0.128481000  0.78104882 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.13_trend -0.78442990 -0.120016500  0.29973045 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.14_trend -0.53425582 -0.104425500  0.28126145 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend3.15_trend -0.53905865  0.126541000  1.03666150 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.1_trend  -0.96221325 -0.267300500  0.17954000 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.2_trend  -0.81677040 -0.137717500  0.43206042 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.3_trend  -0.68935717 -0.063306350  0.51095805 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.4_trend  -0.39826840 -0.004582470  0.45244150 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.5_trend  -0.47715568 -0.020508300  0.39035972 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.6_trend  -0.41250040 -0.020955800  0.44562930 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.7_trend  -0.41914723 -0.072466850  0.29262217 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.8_trend  -0.70114622 -0.076982750  0.51018550 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.9_trend  -0.17231503  0.173177500  0.57119317 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.10_trend -0.20814485  0.267847000  0.85375982 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.11_trend -0.64204347 -0.106467000  0.36206777 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.12_trend -0.90995015 -0.175245500  0.54724160 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.13_trend -0.40526190  0.053782000  0.67097342 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.14_trend -0.34405513  0.087400500  0.58090300 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.15_trend -1.21130250 -0.205266500  0.49812315 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.1_trend  -0.40536728  0.198975500  0.96165707 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.2_trend  -0.44159855  0.240020500  1.27578925 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.3_trend  -1.18574300 -0.375700500  0.31117900 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.4_trend  -0.65588430 -0.203608500  0.22445227 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.5_trend   0.06009611  0.545733000  1.17543425 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.6_trend  -0.18511952  0.232381000  0.83595350 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.7_trend  -0.58283435 -0.175329500  0.19805285 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.8_trend  -0.75700163 -0.108047500  0.60608605 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.9_trend  -0.08247486  0.292681500  0.72955517 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.10_trend -0.01768088  0.449375000  1.04327850 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.11_trend -0.65157645 -0.110626500  0.39162867 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.12_trend -0.87472213 -0.115363500  0.70642375 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.13_trend -0.69148247 -0.013768300  0.56829800 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.14_trend -0.09649246  0.362658000  0.94638390 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.15_trend -0.95555048 -0.072360250  0.84624082 1.00</span></span>
<span><span class="co">##                                     n.eff</span></span>
<span><span class="co">## te(temp,month).1_trend                511</span></span>
<span><span class="co">## te(temp,month).2_trend                472</span></span>
<span><span class="co">## te(temp,month).3_trend                853</span></span>
<span><span class="co">## te(temp,month).4_trend                418</span></span>
<span><span class="co">## te(temp,month).5_trend                301</span></span>
<span><span class="co">## te(temp,month).6_trend                445</span></span>
<span><span class="co">## te(temp,month).7_trend                422</span></span>
<span><span class="co">## te(temp,month).8_trend                515</span></span>
<span><span class="co">## te(temp,month).9_trend                393</span></span>
<span><span class="co">## te(temp,month).10_trend               260</span></span>
<span><span class="co">## te(temp,month).11_trend               333</span></span>
<span><span class="co">## te(temp,month).12_trend               688</span></span>
<span><span class="co">## te(temp,month).13_trend               637</span></span>
<span><span class="co">## te(temp,month).14_trend               481</span></span>
<span><span class="co">## te(temp,month).15_trend               389</span></span>
<span><span class="co">## te(temp,month):trendtrend1.1_trend    714</span></span>
<span><span class="co">## te(temp,month):trendtrend1.2_trend   1000</span></span>
<span><span class="co">## te(temp,month):trendtrend1.3_trend    281</span></span>
<span><span class="co">## te(temp,month):trendtrend1.4_trend    288</span></span>
<span><span class="co">## te(temp,month):trendtrend1.5_trend    344</span></span>
<span><span class="co">## te(temp,month):trendtrend1.6_trend    529</span></span>
<span><span class="co">## te(temp,month):trendtrend1.7_trend    457</span></span>
<span><span class="co">## te(temp,month):trendtrend1.8_trend    218</span></span>
<span><span class="co">## te(temp,month):trendtrend1.9_trend    320</span></span>
<span><span class="co">## te(temp,month):trendtrend1.10_trend   688</span></span>
<span><span class="co">## te(temp,month):trendtrend1.11_trend   156</span></span>
<span><span class="co">## te(temp,month):trendtrend1.12_trend   229</span></span>
<span><span class="co">## te(temp,month):trendtrend1.13_trend   925</span></span>
<span><span class="co">## te(temp,month):trendtrend1.14_trend   532</span></span>
<span><span class="co">## te(temp,month):trendtrend1.15_trend   138</span></span>
<span><span class="co">## te(temp,month):trendtrend2.1_trend    668</span></span>
<span><span class="co">## te(temp,month):trendtrend2.2_trend    895</span></span>
<span><span class="co">## te(temp,month):trendtrend2.3_trend    950</span></span>
<span><span class="co">## te(temp,month):trendtrend2.4_trend    266</span></span>
<span><span class="co">## te(temp,month):trendtrend2.5_trend    439</span></span>
<span><span class="co">## te(temp,month):trendtrend2.6_trend   1009</span></span>
<span><span class="co">## te(temp,month):trendtrend2.7_trend    230</span></span>
<span><span class="co">## te(temp,month):trendtrend2.8_trend    718</span></span>
<span><span class="co">## te(temp,month):trendtrend2.9_trend    606</span></span>
<span><span class="co">## te(temp,month):trendtrend2.10_trend   336</span></span>
<span><span class="co">## te(temp,month):trendtrend2.11_trend   575</span></span>
<span><span class="co">## te(temp,month):trendtrend2.12_trend   816</span></span>
<span><span class="co">## te(temp,month):trendtrend2.13_trend   503</span></span>
<span><span class="co">## te(temp,month):trendtrend2.14_trend   329</span></span>
<span><span class="co">## te(temp,month):trendtrend2.15_trend   364</span></span>
<span><span class="co">## te(temp,month):trendtrend3.1_trend    681</span></span>
<span><span class="co">## te(temp,month):trendtrend3.2_trend    800</span></span>
<span><span class="co">## te(temp,month):trendtrend3.3_trend    685</span></span>
<span><span class="co">## te(temp,month):trendtrend3.4_trend    440</span></span>
<span><span class="co">## te(temp,month):trendtrend3.5_trend    312</span></span>
<span><span class="co">## te(temp,month):trendtrend3.6_trend    773</span></span>
<span><span class="co">## te(temp,month):trendtrend3.7_trend    485</span></span>
<span><span class="co">## te(temp,month):trendtrend3.8_trend    467</span></span>
<span><span class="co">## te(temp,month):trendtrend3.9_trend    303</span></span>
<span><span class="co">## te(temp,month):trendtrend3.10_trend   477</span></span>
<span><span class="co">## te(temp,month):trendtrend3.11_trend   572</span></span>
<span><span class="co">## te(temp,month):trendtrend3.12_trend   558</span></span>
<span><span class="co">## te(temp,month):trendtrend3.13_trend   561</span></span>
<span><span class="co">## te(temp,month):trendtrend3.14_trend   524</span></span>
<span><span class="co">## te(temp,month):trendtrend3.15_trend   695</span></span>
<span><span class="co">## te(temp,month):trendtrend4.1_trend    607</span></span>
<span><span class="co">## te(temp,month):trendtrend4.2_trend    761</span></span>
<span><span class="co">## te(temp,month):trendtrend4.3_trend    915</span></span>
<span><span class="co">## te(temp,month):trendtrend4.4_trend    963</span></span>
<span><span class="co">## te(temp,month):trendtrend4.5_trend    785</span></span>
<span><span class="co">## te(temp,month):trendtrend4.6_trend    949</span></span>
<span><span class="co">## te(temp,month):trendtrend4.7_trend   1124</span></span>
<span><span class="co">## te(temp,month):trendtrend4.8_trend    802</span></span>
<span><span class="co">## te(temp,month):trendtrend4.9_trend    779</span></span>
<span><span class="co">## te(temp,month):trendtrend4.10_trend   529</span></span>
<span><span class="co">## te(temp,month):trendtrend4.11_trend   838</span></span>
<span><span class="co">## te(temp,month):trendtrend4.12_trend   815</span></span>
<span><span class="co">## te(temp,month):trendtrend4.13_trend   819</span></span>
<span><span class="co">## te(temp,month):trendtrend4.14_trend   751</span></span>
<span><span class="co">## te(temp,month):trendtrend4.15_trend   641</span></span>
<span><span class="co">## te(temp,month):trendtrend5.1_trend    451</span></span>
<span><span class="co">## te(temp,month):trendtrend5.2_trend    556</span></span>
<span><span class="co">## te(temp,month):trendtrend5.3_trend    475</span></span>
<span><span class="co">## te(temp,month):trendtrend5.4_trend    655</span></span>
<span><span class="co">## te(temp,month):trendtrend5.5_trend    267</span></span>
<span><span class="co">## te(temp,month):trendtrend5.6_trend    561</span></span>
<span><span class="co">## te(temp,month):trendtrend5.7_trend    529</span></span>
<span><span class="co">## te(temp,month):trendtrend5.8_trend    995</span></span>
<span><span class="co">## te(temp,month):trendtrend5.9_trend    565</span></span>
<span><span class="co">## te(temp,month):trendtrend5.10_trend   324</span></span>
<span><span class="co">## te(temp,month):trendtrend5.11_trend   924</span></span>
<span><span class="co">## te(temp,month):trendtrend5.12_trend   889</span></span>
<span><span class="co">## te(temp,month):trendtrend5.13_trend   805</span></span>
<span><span class="co">## te(temp,month):trendtrend5.14_trend   535</span></span>
<span><span class="co">## te(temp,month):trendtrend5.15_trend   905</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM process smoothing parameter (rho) estimates:</span></span>
<span><span class="co">##                                               2.5%        50%    97.5% Rhat</span></span>
<span><span class="co">## te(temp,month)_rho_trend                1.53605525  3.3072500 4.259870 1.00</span></span>
<span><span class="co">## te(temp,month)2_rho_trend              -0.07558336  2.2888200 3.966894 1.00</span></span>
<span><span class="co">## te(temp,month)3_rho_trend              -0.66817018  2.1776850 4.009583 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend1_rho_trend   0.68762090  2.7441250 4.012247 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend12_rho_trend -2.24343225 -0.4137755 2.692311 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend13_rho_trend -2.04806775  2.4911600 4.083894 1.02</span></span>
<span><span class="co">## te(temp,month):seriestrend2_rho_trend   0.87925208  3.0727800 4.129847 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend22_rho_trend  0.92859582  3.1834500 4.157099 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend23_rho_trend  0.81530258  3.1368850 4.165667 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend3_rho_trend   1.52083050  3.2617700 4.173475 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend32_rho_trend  0.33482032  2.8765900 4.108880 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend33_rho_trend  0.30637410  3.0812000 4.132353 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend4_rho_trend   1.31439875  3.1737300 4.164767 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend42_rho_trend  0.44553562  2.9335850 4.106555 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend43_rho_trend  0.53392142  3.1109900 4.132980 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend5_rho_trend   1.28868725  3.1404200 4.154855 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend52_rho_trend -0.21972502  2.0034950 3.883226 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend53_rho_trend  0.28449695  2.9834650 4.148620 1.01</span></span>
<span><span class="co">##                                        n.eff</span></span>
<span><span class="co">## te(temp,month)_rho_trend                1220</span></span>
<span><span class="co">## te(temp,month)2_rho_trend                281</span></span>
<span><span class="co">## te(temp,month)3_rho_trend                406</span></span>
<span><span class="co">## te(temp,month):seriestrend1_rho_trend    796</span></span>
<span><span class="co">## te(temp,month):seriestrend12_rho_trend   184</span></span>
<span><span class="co">## te(temp,month):seriestrend13_rho_trend   157</span></span>
<span><span class="co">## te(temp,month):seriestrend2_rho_trend    192</span></span>
<span><span class="co">## te(temp,month):seriestrend22_rho_trend   445</span></span>
<span><span class="co">## te(temp,month):seriestrend23_rho_trend   383</span></span>
<span><span class="co">## te(temp,month):seriestrend3_rho_trend   1056</span></span>
<span><span class="co">## te(temp,month):seriestrend32_rho_trend   358</span></span>
<span><span class="co">## te(temp,month):seriestrend33_rho_trend   396</span></span>
<span><span class="co">## te(temp,month):seriestrend4_rho_trend    866</span></span>
<span><span class="co">## te(temp,month):seriestrend42_rho_trend   469</span></span>
<span><span class="co">## te(temp,month):seriestrend43_rho_trend   538</span></span>
<span><span class="co">## te(temp,month):seriestrend5_rho_trend    859</span></span>
<span><span class="co">## te(temp,month):seriestrend52_rho_trend   374</span></span>
<span><span class="co">## te(temp,month):seriestrend53_rho_trend   526</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Stan MCMC diagnostics:</span></span>
<span><span class="co">## n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">## Rhats above 1.05 found for 11 parameters</span></span>
<span><span class="co">## *Diagnose further to investigate why the chains have not mixed</span></span>
<span><span class="co">## 0 of 2000 iterations ended with a divergence (0%)</span></span>
<span><span class="co">## 0 of 2000 iterations saturated the maximum tree depth of 12 (0%)</span></span>
<span><span class="co">## Chain 3: E-FMI = 0.1561</span></span>
<span><span class="co">## *E-FMI below 0.2 indicates you may need to reparameterize your model</span></span></code></pre>
<p>The convergence of this model isn’t fabulous (more on this in a
moment). But we can again plot the smooth functions, which this time
operate on the process model. We can see the same plot using
<code>trend_effects = TRUE</code> in the plotting functions:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, <span class="st">'smooths'</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-33-1.png" width="60%" style="display: block; margin: auto;"><img src="trend_formulas_files/figure-html/unnamed-chunk-33-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>The VAR matrix is of particular interest here, as it captures lagged
dependencies and cross-dependencies in the latent process model:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, variable <span class="op">=</span> <span class="st">'A'</span>, regex <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-34-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Unfortunately <code>bayesplot</code> doesn’t know this is a matrix of
parameters so what we see is actually the transpose of the VAR matrix. A
little bit of wrangling gives us these histograms in the correct
order:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">A_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'A['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-35-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>There is a lot happening in this matrix. Each cell captures the
lagged effect of the process in the column on the process in the row in
the next timestep. So for example, the effect in cell [3,1], which is
quite strongly negative, means that an <em>increase</em> in the process
for series 3 (Greens) at time <span class="math inline">\(t\)</span> is
expected to lead to a subsequent <em>decrease</em> in the process for
series 1 (Bluegreens) at time <span class="math inline">\(t+1\)</span>.
The latent process model is now capturing these effects and the smooth
seasonal effects, so the trend plot shows our best estimate of what the
<em>true</em> count should have been at each time point:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-36-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-37-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The process error <span class="math inline">\((\Sigma)\)</span>
captures unmodelled variation in the process models. Again, we fixed the
off-diagonals to 0, so the histograms for these will look like flat
boxes:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Sigma_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sigma['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Sigma_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-38-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The observation error estimates <span class="math inline">\((\sigma_{obs})\)</span> represent how much the
model thinks we might miss the true count when we take our imperfect
measurements:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, variable <span class="op">=</span> <span class="st">'sigma_obs'</span>, regex <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-39-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>These are still a bit hard to identify overall.</p>
</div>
<div class="section level3">
<h3 id="correlated-process-errors">Correlated process errors<a class="anchor" aria-label="anchor" href="#correlated-process-errors"></a>
</h3>
<p>Let’s see if the estimates improve when we allow the process errors
to be correlated. Once again, we need to first update the priors for the
observation errors:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with correlated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1cor'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># update the sigma_obs prior so that it avoids very small</span></span>
<span><span class="co"># and very large values that are nonsensical</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">prior</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"sigma_obs ~ uniform(0.1, 1);"</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_lowerbound</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_upperbound</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>And now we can fit the correlated process error model.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">varcor_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span>  </span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with correlated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1cor'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>  </span>
<span>  <span class="co"># include the updated priors</span></span>
<span>  priors <span class="op">=</span> <span class="va">priors</span><span class="op">)</span></span></code></pre></div>
<p>Plot convergence diagnostics for the two models, which shows that the
more complex model with correlated errors has better convergence:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'rhat'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">'VAR1cor'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-42-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'rhat'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">'VAR1'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-42-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can also check convergence using one of the package’s inbuilt
utility functions:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mvgam</span><span class="fu">:::</span><span class="fu">check_rhat</span><span class="op">(</span><span class="va">varcor_mod</span><span class="op">$</span><span class="va">model_output</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rhats above 1.05 found for 8 parameters</span></span>
<span><span class="co">## *Diagnose further to investigate why the chains have not mixed</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mvgam</span><span class="fu">:::</span><span class="fu">check_rhat</span><span class="op">(</span><span class="va">var_mod</span><span class="op">$</span><span class="va">model_output</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rhats above 1.05 found for 11 parameters</span></span>
<span><span class="co">## *Diagnose further to investigate why the chains have not mixed</span></span></code></pre>
<p>This model has converged better than the first model (that assumed
process errors were independent), possibly telling us that this is a
more appropriate model. The <span class="math inline">\((\Sigma)\)</span> matrix now captures any evidence
of contemporaneously correlated process error:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Sigma_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sigma['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">varcor_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Sigma_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-44-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>This symmetric matrix tells us there is support for correlated
process errors. For example, series 1 and 3 (Bluegreens and Greens) show
negatively correlated process errors, while series 1 and 4 (Bluegreens
and Other.algae) show positively correlated errors. Because this model
is able to capture correlated errors, the VAR matrix has changed
slightly:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">A_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'A['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">varcor_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-45-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We still have some evidence of lagged cross-dependence, but some of
these interactions have now been pulled more toward zero. But which
model is better? Forecasts don’t appear to differ very much, at least
qualitatively (here are forecasts for two of the series, for each
model):</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-46-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 2.846129</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-47-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 3.110618</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">2</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-48-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 6.274732</span></span></code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">2</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-49-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 5.857996</span></span></code></pre>
<p>We can compute the variogram score for out of sample forecasts to get
a sense of which model does a better job of capturing the dependence
structure in the true evaluation set:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create forecast objects for each model</span></span>
<span><span class="va">fcvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">var_mod</span><span class="op">)</span></span>
<span><span class="va">fcvarcor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">varcor_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the difference in variogram scores; a negative value means the VAR1cor model is better, while a positive value means the VAR1 model is better</span></span>
<span><span class="va">diff_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvarcor</span>, score <span class="op">=</span> <span class="st">'variogram'</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span> <span class="op">-</span></span>
<span>  <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvar</span>, score <span class="op">=</span> <span class="st">'variogram'</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diff_scores</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.25</span>, col <span class="op">=</span> <span class="st">'darkred'</span>, </span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     bty <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">'Forecast horizon'</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">variogram</span><span class="op">[</span><span class="va">VAR1cor</span><span class="op">]</span><span class="op">~</span><span class="op">-</span><span class="op">~</span><span class="va">variogram</span><span class="op">[</span><span class="va">VAR1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-50-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The VAR1cor model seems to do a better job overall, but there are
some horizons where the uncorrelated error model gives slightly better
forecasts. This is often the case when comparing models: some models
give better forecasts <em>some of the time</em>, while other models do
better in other contexts. But overall, I’d choose the second model here
as it converged better and tends to give better community-level
forecasts</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nicholas J Clark.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
