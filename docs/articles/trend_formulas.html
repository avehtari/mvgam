<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>State-Space models in the mvgam package • mvgam</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="State-Space models in the mvgam package">
<meta property="og:description" content="mvgam">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in the mvgam package</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>State-Space models in the mvgam package</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2023-09-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/trend_formulas.Rmd" class="external-link"><code>vignettes/trend_formulas.Rmd</code></a></small>
      <div class="d-none name"><code>trend_formulas.Rmd</code></div>
    </div>

    
    
<p>The purpose of this vignette is to show how the <code>mvgam</code>
package can be used to fit and interrogate State-Space models with
nonlinear effects.</p>
<div class="section level2">
<h2 id="state-space-models">State-Space Models<a class="anchor" aria-label="anchor" href="#state-space-models"></a>
</h2>
<div class="figure">
<img src="SS_model.svg" style="width:85.0%" alt=""><p class="caption">Illustration of a basic State-Space model, which
assumes that a latent dynamic <em>process</em> (X) can evolve
independently from the way we take <em>observations</em> (Y) of that
process</p>
</div>
<p><br></p>
<p>State-Space models allow us to separately make inferences about the
underlying dynamic <em>process model</em> that we are interested in
(i.e. the evolution of a time series or a collection of time series) and
the <em>observation model</em> (i.e. the way that we survey / measure
this underlying process). This is extremely useful in ecology because
our observations are always imperfect / noisy measurements of the thing
we are interested in measuring. It is also helpful because we often know
that some covariates will impact our ability to measure accurately
(i.e. we cannot take accurate counts of rodents if there is a
thunderstorm happening) while other covariate impact the underlying
process (it is highly unlikely that rodent abundance responds to one
storm, but instead probably responds to longer-term weather and climate
variation). A State-Space model allows us to model both components in a
single unified modelling framework. A major advantage of
<code>mvgam</code> is that it can include nonlinear effects and random
effects in BOTH model components while also capturing dynamic
processes.</p>
<div class="section level3">
<h3 id="lake-washington-plankton-data">Lake Washington plankton data<a class="anchor" aria-label="anchor" href="#lake-washington-plankton-data"></a>
</h3>
<p>The data we will use to illustrate how we can fit State-Space models
in <code>mvgam</code> are from a long-term monitoring study of plankton
counts (cells per mL) taken from Lake Washington in Washington, USA. The
data are available as part of the <code>MARSS</code> package and can be
downloaded using the following:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">'https://github.com/atsa-es/MARSS/raw/master/data/lakeWAplankton.rda'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will work with five different groups of plankton:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Greens'</span>, <span class="st">'Bluegreens'</span>, <span class="st">'Diatoms'</span>, <span class="st">'Unicells'</span>, <span class="st">'Other.algae'</span><span class="op">)</span></span></code></pre></div>
<p>As usual, preparing the data into the correct format for
<code>mvgam</code> modelling takes a little bit of wrangling in
<code>dplyr</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># loop across each plankton group to create the long datframe</span></span>
<span><span class="va">plankton_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">outcomes</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># create a group-specific dataframe with counts labelled 'y'</span></span>
<span>  <span class="co"># and the group name in the 'series' variable</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">'Year'</span><span class="op">]</span>,</span>
<span>             month <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">'Month'</span><span class="op">]</span>,</span>
<span>             y <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="va">x</span><span class="op">]</span>,</span>
<span>             series <span class="op">=</span> <span class="va">x</span>,</span>
<span>             temp <span class="op">=</span> <span class="va">lakeWAplanktonTrans</span><span class="op">[</span>, <span class="st">'Temp'</span><span class="op">]</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># change the 'series' label to a factor</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># filter to only include some years in the data</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">year</span> <span class="op">&gt;=</span> <span class="fl">1965</span> <span class="op">&amp;</span> <span class="va">year</span> <span class="op">&lt;</span> <span class="fl">1975</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># z-score the counts so they are approximately standard normal</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># add the time indicator</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Inspect the data structure</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">##    year month       y series       temp  time</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.542</span>  Greens      -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.344</span>  Bluegreens  -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.076</span><span style="color: #BB0000; text-decoration: underline;">8</span> Diatoms     -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">1.52</span>   Unicells    -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span>  <span style="text-decoration: underline;">1</span>965     1 -<span style="color: #BB0000;">0.491</span>  Other.algae -<span style="color: #BB0000;">1.23</span>     1</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span>  <span style="text-decoration: underline;">1</span>965     2 <span style="color: #BB0000;">NA</span>      Greens      -<span style="color: #BB0000;">1.32</span>     2</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 600</span></span>
<span><span class="co">## Columns: 6</span></span>
<span><span class="co">## $ year   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 1965, 196…</span></span>
<span><span class="co">## $ month  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, …</span></span>
<span><span class="co">## $ y      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.54241769, -0.34410776, -0.07684901, -1.52243490, -0.49055442…</span></span>
<span><span class="co">## $ series <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span> Greens, Bluegreens, Diatoms, Unicells, Other.algae, Greens, Blu…</span></span>
<span><span class="co">## $ temp   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -1.2306562, -1.2306562, -1.2306562, -1.2306562, -1.2306562, -1.…</span></span>
<span><span class="co">## $ time   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 5, …</span></span></code></pre>
<p>Note that we have z-scored the counts in this example as that will
make it easier to specify priors (though this is not completely
necessary; it is often better to build a model that respects the
properties of the actual outcome variables)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plankton_data</span>, series <span class="op">=</span> <span class="st">'all'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-6-1.png" width="60%" style="display: block; margin: auto;"><img src="trend_formulas_files/figure-html/unnamed-chunk-6-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>As usual, check the data for <code>NA</code>s:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span><span class="op">)</span>, axes <span class="op">=</span> <span class="cn">F</span>,</span>
<span>      col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'grey80'</span>, <span class="st">'darkred'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span><span class="fl">3</span>, at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>, len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NCOL</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span><span class="op">)</span>, </span>
<span>     labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">plankton_data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-7-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We have some missing observations, but of course this isn’t an issue
for modelling in <code>mvgam</code>. A useful property to understand
about these counts is that they tend to be highly seasonal. Below are
some plots of z-scored counts against the z-scored temperature
measurements in the lake for each month:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">'Other.algae'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">'z-score'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'Temperature (black) vs Other algae (red)'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-8-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">'Diatoms'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">'z-score'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'Temperature (black) vs Diatoms (red)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-9-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">series</span> <span class="op">==</span> <span class="st">'Greens'</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">temp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'white'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'darkred'</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ylab</span><span class="op">(</span><span class="st">'z-score'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">xlab</span><span class="op">(</span><span class="st">'Time'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggtitle</span><span class="op">(</span><span class="st">'Temperature (black) vs Greens (red)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-10-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We will have to try and capture this seasonality in our process
model, which should be easy to do given the flexibility of GAMs. Next we
will split the data into training and testing splits:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plankton_train</span> <span class="op">&lt;-</span> <span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="fl">112</span><span class="op">)</span></span>
<span><span class="va">plankton_test</span> <span class="op">&lt;-</span> <span class="va">plankton_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">112</span><span class="op">)</span></span></code></pre></div>
<p>Now time to fit some models. This requires a bit of thinking about
how we can best tackle the seasonal variation and the likely dependence
structure in the data. These algae are interacting as part of a complex
system within the same lake, so we certainly expect there to be some
lagged cross-dependencies underling their dynamics. But if we do not
capture the seasonal variation, our multivariate dynamic model will be
forced to try and capture it, which could lead to poor convergence and
unstable results (we could feasibly capture cyclic dynamics with a more
complex multi-species Lotka-Volterra model, but ordinary differential
equation approaches are beyond the scope of this workshop).</p>
</div>
<div class="section level3">
<h3 id="capturing-seasonality">Capturing seasonality<a class="anchor" aria-label="anchor" href="#capturing-seasonality"></a>
</h3>
<p>First we will fit a model that does not include a dynamic component,
just to see if it can reproduce the seasonal variation in the
observations. This model builds from our hierarchical GAMs above by
introducing hierarchical multidimensional smooths. It includes a
“global” tensor product of the <code>month</code> and <code>temp</code>
variables, capturing our expectation that algal seasonality responds to
temperature variation. But this response should depend on when in the
year these temperatures are recorded (i.e. a response to warm
temperatures in Spring should be different to a response to warm
temperatures in Autumn). The model also fits series-specific deviation
smooths (i.e. one tensor product per series) to capture how each algal
group’s seasonality differs from the overall “global” seasonality. Note
that we do not include series-specific intercepts in this model because
each series was z-scored to have a mean of 0.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">notrend_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> </span>
<span>                       <span class="co"># tensor of temp and month to capture</span></span>
<span>                       <span class="co"># "global" seasonality</span></span>
<span>                       <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                       </span>
<span>                       <span class="co"># series-specific deviation tensor products</span></span>
<span>                       <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span>,</span>
<span>                     family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>                     trend_model <span class="op">=</span> <span class="st">'None'</span><span class="op">)</span></span></code></pre></div>
<p>The “global” tensor product smooth function can be quickly
visualized:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-13-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can then plot the deviation smooths for each algal group to see
how they vary from the “global” pattern:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-14-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-15-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-16-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-17-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_smooth.html">plot_mvgam_smooth</a></span><span class="op">(</span><span class="va">notrend_mod</span>, smooth <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-18-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>These multidimensional smooths have done a good job of capturing the
seasonal variation in our observations:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-19-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-20-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-21-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-22-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-23-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="multiseries-dynamics">Multiseries dynamics<a class="anchor" aria-label="anchor" href="#multiseries-dynamics"></a>
</h3>
<p>The basic model gives us confidence that we can capture the seasonal
variation in the observations. But the model has not captured the
remaining temporal dynamics, which is obvious when we inspect Dunn-Smyth
residuals for each series:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-24-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-25-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-26-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-27-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">notrend_mod</span>, type <span class="op">=</span> <span class="st">'residuals'</span>, series <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-28-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Now it is time to get into multivariate State-Space models. We will
fit two models that can both incorporate lagged cross-dependencies in
the latent process models. The first model assumes that the process
errors operate independnetly from one another, while the second assumes
that there may be contemporaneous correlations in the process errors.
Both models include a Vector Autoregressive component for the process
means, and so both can model complex community dynamics. The models can
be described mathematically as follows:</p>
<p><span class="math display">\[\begin{align*}
\boldsymbol{count}_t &amp; \sim \text{Normal}(\mu_{obs[t]},
\sigma_{obs}) \\
\mu_{obs[t]} &amp; = \alpha + process_t \\
\sigma_{obs} &amp; \sim \text{Uniform}(0.1, 1) \\
process_t &amp; \sim \text{MVNormal}(\mu_{process[t]}, \Sigma_{process})
\\
\mu_{process[t]} &amp; = VAR * process_{t-1} +
f_{global}(\boldsymbol{month},\boldsymbol{temp})_t +
f_{series}(\boldsymbol{month},\boldsymbol{temp})_t \\
f_{global}(\boldsymbol{month},\boldsymbol{temp}) &amp; =
\sum_{k=1}^{K}b_{global} * \beta_{global} \\
f_{series}(\boldsymbol{month},\boldsymbol{temp}) &amp; =
\sum_{k=1}^{K}b_{series} * \beta_{series} \\
VAR &amp; \sim \text{Normal}(0, 1) \\
\Sigma_{process} &amp; = \text{diag}(\sigma_{process}) * \text{R} *
\text{diag}(\sigma_{process}) \\
\text{R} &amp; \sim \text{LKJcorr}(2) \end{align*}\]</span></p>
<p>Here you can see that we assume independent observation processes
(there is no covariance structure in the observation errors <span class="math inline">\(\sigma_{obs}\)</span>) but there is a lot going on
in the underlying process model. This component has a Vector
Autoregressive part (where the process mean at time <span class="math inline">\(t\)</span> <span class="math inline">\((\mu_{process[t]})\)</span>) is a vector that
evolves as a function of where the vector-valued process model was at
time <span class="math inline">\(t-1\)</span>. The <span class="math inline">\(VAR\)</span> matrix captures these dynamics with
self-dependencies on the diagonal and possibly assymetric
cross-dependencies on the off-diagonals. The contemporaneous process
errors are captured by <span class="math inline">\(\Sigma_{process}\)</span>, which can be
constrained so that process errors are independent (i.e. setting the
off-diagonals to 0) or can be fully parameterized using a Cholesky
decomposition (using <code>Stan</code>’s <span class="math inline">\(LKJcorr\)</span> distribution to place a prior on
the strength of inter-species correlations).</p>
<p><br> Ok that was a lot to take in. Let’s fit some models to try and
inspect what is going on and what they assume. But first, we need to
update <code>mvgam</code>’s default priors for the observation errors.
By default, <code>mvgam</code> uses a fairly wide Student-T prior on
this parameter because the package doesn’t know what range the
observations will be on. But our observations are z-scored and so we do
not expect very large observation errors. However, we also do not expect
very small observation errors. So let’s update the prior for this
parameter. In doing so, you will get to see how the formula for the
latent process (i.e. trend) model is used in <code>mvgam</code>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with uncorrelated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># update the sigma_obs prior so that it avoids very small</span></span>
<span><span class="co"># and very large values that are nonsensical</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">prior</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"sigma_obs ~ uniform(0.1, 1);"</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_lowerbound</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_upperbound</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>Note that if you already know the names of parameters for which you’d
like to modify the priors, you can more quickly make edits using
<code>brms</code> functionality:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu">prior</span><span class="op">(</span><span class="fu">uniform</span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sigma_obs</span>, lb <span class="op">=</span> <span class="fl">0.1</span>, ub <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>Now we can fit the first model, which assumes that process errors are
contemporaneously uncorrelated</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span>  </span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with uncorrelated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>  </span>
<span>  <span class="co"># include the updated priors</span></span>
<span>  priors <span class="op">=</span> <span class="va">priors</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inspecting-ss-models">Inspecting SS models<a class="anchor" aria-label="anchor" href="#inspecting-ss-models"></a>
</h3>
<p>This model’s summary is a bit different to other <code>mvgam</code>
summaries. It separates parameters based on whether they belong to the
observation model or to the latent process model. This is because we may
often have covariates that impact the observations but not the latent
process, so we can have fairly complex models for each component. You
will notice that some parameters have not fully converged, particularly
for the VAR coefficients (called <code>A</code> in the output) and for
the process errors (<code>Sigma</code>)</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">var_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## GAM observation formula:</span></span>
<span><span class="co">## y ~ 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM process formula:</span></span>
<span><span class="co">## ~te(temp, month, k = c(4, 4)) + te(temp, month, k = c(4, 4), </span></span>
<span><span class="co">##     by = trend)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Family:</span></span>
<span><span class="co">## gaussian</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Link function:</span></span>
<span><span class="co">## identity</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Trend model:</span></span>
<span><span class="co">## VAR1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## N process models:</span></span>
<span><span class="co">## 5 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## N series:</span></span>
<span><span class="co">## 5 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## N timepoints:</span></span>
<span><span class="co">## 112 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Status:</span></span>
<span><span class="co">## Fitted using Stan </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Observation error parameter estimates:</span></span>
<span><span class="co">##                   2.5%       50%     97.5% Rhat n.eff</span></span>
<span><span class="co">## sigma_obs[1] 0.1052991 0.1811495 0.2813464 1.02   144</span></span>
<span><span class="co">## sigma_obs[2] 0.1242697 0.2949510 0.5204035 1.20    14</span></span>
<span><span class="co">## sigma_obs[3] 0.6946586 0.8695095 0.9845834 1.05   170</span></span>
<span><span class="co">## sigma_obs[4] 0.1052882 0.2615715 0.4288121 1.06    57</span></span>
<span><span class="co">## sigma_obs[5] 0.1595682 0.4081365 0.5494945 1.02    84</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM observation model coefficient (beta) estimates:</span></span>
<span><span class="co">##                   2.5%        50%      97.5% Rhat n.eff</span></span>
<span><span class="co">## (Intercept) -0.1391948 -0.0449367 0.05325132 1.02   147</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process model VAR parameter estimates:</span></span>
<span><span class="co">##               2.5%           50%       97.5% Rhat n.eff</span></span>
<span><span class="co">## A[1,1]  0.09091800  0.4000530000 0.677639700 1.01   460</span></span>
<span><span class="co">## A[1,2] -0.97956900  0.3463950000 1.651819000 1.06    74</span></span>
<span><span class="co">## A[1,3] -0.50627168 -0.2152230000 0.006505871 1.02   270</span></span>
<span><span class="co">## A[1,4] -0.18597490  0.0662921500 0.343116975 1.02   139</span></span>
<span><span class="co">## A[1,5] -0.04814212  0.2194740000 0.674904000 1.02   268</span></span>
<span><span class="co">## A[2,1] -0.31033278 -0.0404800500 0.188636950 1.03   142</span></span>
<span><span class="co">## A[2,2] -0.04131058  0.6830670000 0.994074800 1.02   131</span></span>
<span><span class="co">## A[2,3] -0.16341940 -0.0006169285 0.138744175 1.01   478</span></span>
<span><span class="co">## A[2,4] -0.12301905  0.0090723350 0.266247975 1.03   124</span></span>
<span><span class="co">## A[2,5] -0.18249940  0.0044988400 0.253894800 1.01   391</span></span>
<span><span class="co">## A[3,1] -0.43564143 -0.1547365000 0.014242595 1.03   166</span></span>
<span><span class="co">## A[3,2] -0.35605073  0.0720120000 0.656650675 1.04   279</span></span>
<span><span class="co">## A[3,3]  0.57351807  0.7504070000 0.886146875 1.00   503</span></span>
<span><span class="co">## A[3,4] -0.07032817  0.0535489000 0.192888425 1.00   651</span></span>
<span><span class="co">## A[3,5] -0.02462768  0.1391675000 0.408809100 1.01   296</span></span>
<span><span class="co">## A[4,1] -0.62385665 -0.1888940000 0.100756200 1.02   212</span></span>
<span><span class="co">## A[4,2] -0.76857165  0.5292465000 2.014025750 1.07    71</span></span>
<span><span class="co">## A[4,3] -0.45724915 -0.1492865000 0.087988112 1.01   224</span></span>
<span><span class="co">## A[4,4]  0.37418228  0.6716615000 0.913073100 1.02   148</span></span>
<span><span class="co">## A[4,5] -0.13258020  0.1841570000 0.685445875 1.01   196</span></span>
<span><span class="co">## A[5,1] -0.43833360 -0.0856798000 0.144713525 1.03   145</span></span>
<span><span class="co">## A[5,2] -0.62475467  0.1808065000 1.210113000 1.05   130</span></span>
<span><span class="co">## A[5,3] -0.09258733  0.0689361000 0.297405775 1.00   278</span></span>
<span><span class="co">## A[5,4] -0.23924850 -0.0479704000 0.129515675 1.01   312</span></span>
<span><span class="co">## A[5,5]  0.38084458  0.7104450000 0.926108950 1.01   158</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Process error parameter estimates:</span></span>
<span><span class="co">##                   2.5%        50%     97.5% Rhat n.eff</span></span>
<span><span class="co">## Sigma[1,1] 0.049459570 0.18539350 0.3458370 1.12    30</span></span>
<span><span class="co">## Sigma[1,2] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[1,3] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[1,4] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[1,5] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,1] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,2] 0.009012433 0.04584075 0.2548712 1.25    19</span></span>
<span><span class="co">## Sigma[2,3] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,4] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[2,5] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,1] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,2] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,3] 0.079234650 0.13648650 0.2055316 1.01   298</span></span>
<span><span class="co">## Sigma[3,4] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[3,5] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,1] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,2] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,3] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[4,4] 0.099436140 0.22625650 0.3926745 1.04   119</span></span>
<span><span class="co">## Sigma[4,5] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,1] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,2] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,3] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,4] 0.000000000 0.00000000 0.0000000  NaN   NaN</span></span>
<span><span class="co">## Sigma[5,5] 0.049385695 0.12917400 0.3219656 1.01    88</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM process model coefficient (beta) estimates:</span></span>
<span><span class="co">##                                            2.5%          50%       97.5% Rhat</span></span>
<span><span class="co">## te(temp,month).1_trend              -0.73788025 -0.230447000  0.32427292 1.00</span></span>
<span><span class="co">## te(temp,month).2_trend              -0.74740668 -0.050644900  0.84017467 1.00</span></span>
<span><span class="co">## te(temp,month).3_trend              -1.09053100 -0.325192500  0.31186270 1.00</span></span>
<span><span class="co">## te(temp,month).4_trend              -0.60879025 -0.226713000  0.14807600 1.02</span></span>
<span><span class="co">## te(temp,month).5_trend              -0.07064458  0.298666000  0.76109602 1.02</span></span>
<span><span class="co">## te(temp,month).6_trend              -0.38945945  0.036743300  0.60984428 1.01</span></span>
<span><span class="co">## te(temp,month).7_trend              -0.55888058 -0.227418000  0.08935860 1.00</span></span>
<span><span class="co">## te(temp,month).8_trend              -0.85095097 -0.187895000  0.65785577 1.01</span></span>
<span><span class="co">## te(temp,month).9_trend               0.05928827  0.405286500  0.79234040 1.03</span></span>
<span><span class="co">## te(temp,month).10_trend              0.24841303  0.672046000  1.13550475 1.04</span></span>
<span><span class="co">## te(temp,month).11_trend             -0.75532708 -0.164412000  0.42114777 1.01</span></span>
<span><span class="co">## te(temp,month).12_trend             -1.02365450 -0.206441500  1.02021650 1.01</span></span>
<span><span class="co">## te(temp,month).13_trend             -0.41026595  0.162632000  0.79710922 1.00</span></span>
<span><span class="co">## te(temp,month).14_trend              0.13187200  0.604971000  1.05417950 1.02</span></span>
<span><span class="co">## te(temp,month).15_trend             -1.18576925 -0.061258550  1.13251200 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.1_trend  -0.20649007  0.728945500  1.55768150 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.2_trend  -0.87366363  0.535348000  1.91913450 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.3_trend  -1.23695275 -0.298422500  0.93104867 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.4_trend  -0.53196487  0.002278480  0.66256680 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.5_trend   0.58097515  1.216720000  1.80503950 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.6_trend  -0.76644028  0.072939000  0.87063967 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.7_trend  -0.73476070 -0.244208500  0.26460395 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.8_trend  -0.90043045 -0.031059500  1.38734875 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.9_trend   0.40481720  1.129325000  1.72797100 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.10_trend -1.10125875 -0.472596000  0.19553080 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend1.11_trend -1.32126175 -0.049901050  0.67694755 1.03</span></span>
<span><span class="co">## te(temp,month):trendtrend1.12_trend -1.19774900 -0.047073000  1.72462000 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend1.13_trend -0.73775623  0.447504500  1.64612000 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.14_trend -1.45259875 -0.744650500 -0.04983485 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend1.15_trend -2.29279500  0.414270000  1.80242200 1.04</span></span>
<span><span class="co">## te(temp,month):trendtrend2.1_trend  -0.32399565  0.127947500  0.75978612 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.2_trend  -0.43867845  0.090215750  0.71759740 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.3_trend  -0.61620822  0.005699600  0.58096690 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.4_trend  -0.63718493 -0.145199500  0.24384965 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.5_trend  -0.42839647 -0.002569680  0.47318220 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.6_trend  -0.34704855  0.014668400  0.42766212 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.7_trend  -0.52084040 -0.100791500  0.28341800 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.8_trend  -0.68303140 -0.095755900  0.42515125 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.9_trend  -0.39803615 -0.003709595  0.37114490 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend2.10_trend -0.50076252 -0.029677450  0.43012475 1.02</span></span>
<span><span class="co">## te(temp,month):trendtrend2.11_trend -0.52618725 -0.067361800  0.35221242 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.12_trend -0.61990492  0.022730200  0.67112987 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.13_trend -0.32395170  0.124677000  0.63854585 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend2.14_trend -0.25525297  0.153094000  0.64843202 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend2.15_trend -0.65743575  0.068956550  0.80927735 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.1_trend  -0.61449245 -0.078767100  0.38252060 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend3.2_trend  -0.79608932 -0.102499500  0.38932497 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend3.3_trend  -0.46752965  0.088040100  0.74869657 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.4_trend  -0.37177815  0.018692650  0.42550347 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.5_trend  -0.79053142 -0.243218500  0.12250802 1.03</span></span>
<span><span class="co">## te(temp,month):trendtrend3.6_trend  -0.53255707 -0.099852250  0.24177667 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.7_trend  -0.13084535  0.190139500  0.56300117 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.8_trend  -0.56623190  0.021381000  0.60326032 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.9_trend  -0.73973655 -0.234461500  0.10080305 1.03</span></span>
<span><span class="co">## te(temp,month):trendtrend3.10_trend -0.52607270 -0.034494000  0.36275635 1.03</span></span>
<span><span class="co">## te(temp,month):trendtrend3.11_trend -0.18796715  0.227658500  0.71165955 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.12_trend -0.65574957  0.120966000  0.80479397 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.13_trend -0.73654630 -0.131729000  0.29696047 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.14_trend -0.56467608 -0.131117500  0.30480582 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend3.15_trend -0.54731040  0.123452500  0.93538837 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.1_trend  -0.94832363 -0.285925500  0.19024445 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.2_trend  -0.81493550 -0.157447000  0.45360282 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.3_trend  -0.77749375 -0.062661200  0.49554525 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.4_trend  -0.39211130 -0.002852865  0.42670787 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.5_trend  -0.46421285 -0.005265335  0.42423950 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.6_trend  -0.41473412 -0.030761200  0.44882722 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.7_trend  -0.44119913 -0.057631450  0.26824877 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.8_trend  -0.61153537 -0.064239750  0.56985362 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.9_trend  -0.15156105  0.179617500  0.63782870 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.10_trend -0.16127482  0.284152500  0.84657857 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.11_trend -0.62272665 -0.078763400  0.40524877 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.12_trend -0.89729800 -0.175094500  0.68422402 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.13_trend -0.40670460  0.039881850  0.63828035 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend4.14_trend -0.34796122  0.080747750  0.58681512 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend4.15_trend -1.05269675 -0.201703500  0.57803562 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.1_trend  -0.40499020  0.211310000  0.93989577 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.2_trend  -0.42797652  0.244051000  1.30928100 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.3_trend  -1.17512750 -0.358366000  0.33379357 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.4_trend  -0.65833645 -0.194516500  0.29514262 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.5_trend   0.04513567  0.565158500  1.19330075 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.6_trend  -0.19987937  0.229852500  0.90240530 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.7_trend  -0.57416228 -0.170717000  0.20907520 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.8_trend  -0.72023595 -0.106386000  0.69482212 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.9_trend  -0.08523457  0.305309000  0.73983945 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.10_trend -0.07126673  0.437620000  1.07315775 1.03</span></span>
<span><span class="co">## te(temp,month):trendtrend5.11_trend -0.61873727 -0.135481000  0.37142952 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.12_trend -0.88794045 -0.145928500  0.62389335 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.13_trend -0.69359570 -0.032394700  0.51417732 1.00</span></span>
<span><span class="co">## te(temp,month):trendtrend5.14_trend -0.12237095  0.327509500  0.94098200 1.01</span></span>
<span><span class="co">## te(temp,month):trendtrend5.15_trend -1.01056525 -0.121452500  0.80954160 1.01</span></span>
<span><span class="co">##                                     n.eff</span></span>
<span><span class="co">## te(temp,month).1_trend                463</span></span>
<span><span class="co">## te(temp,month).2_trend                487</span></span>
<span><span class="co">## te(temp,month).3_trend                643</span></span>
<span><span class="co">## te(temp,month).4_trend                254</span></span>
<span><span class="co">## te(temp,month).5_trend                274</span></span>
<span><span class="co">## te(temp,month).6_trend                360</span></span>
<span><span class="co">## te(temp,month).7_trend                376</span></span>
<span><span class="co">## te(temp,month).8_trend                292</span></span>
<span><span class="co">## te(temp,month).9_trend                229</span></span>
<span><span class="co">## te(temp,month).10_trend               149</span></span>
<span><span class="co">## te(temp,month).11_trend               245</span></span>
<span><span class="co">## te(temp,month).12_trend               456</span></span>
<span><span class="co">## te(temp,month).13_trend               557</span></span>
<span><span class="co">## te(temp,month).14_trend               300</span></span>
<span><span class="co">## te(temp,month).15_trend               295</span></span>
<span><span class="co">## te(temp,month):trendtrend1.1_trend    559</span></span>
<span><span class="co">## te(temp,month):trendtrend1.2_trend    676</span></span>
<span><span class="co">## te(temp,month):trendtrend1.3_trend    369</span></span>
<span><span class="co">## te(temp,month):trendtrend1.4_trend    369</span></span>
<span><span class="co">## te(temp,month):trendtrend1.5_trend    418</span></span>
<span><span class="co">## te(temp,month):trendtrend1.6_trend    450</span></span>
<span><span class="co">## te(temp,month):trendtrend1.7_trend    433</span></span>
<span><span class="co">## te(temp,month):trendtrend1.8_trend    285</span></span>
<span><span class="co">## te(temp,month):trendtrend1.9_trend    319</span></span>
<span><span class="co">## te(temp,month):trendtrend1.10_trend   684</span></span>
<span><span class="co">## te(temp,month):trendtrend1.11_trend   185</span></span>
<span><span class="co">## te(temp,month):trendtrend1.12_trend   414</span></span>
<span><span class="co">## te(temp,month):trendtrend1.13_trend   576</span></span>
<span><span class="co">## te(temp,month):trendtrend1.14_trend   607</span></span>
<span><span class="co">## te(temp,month):trendtrend1.15_trend   168</span></span>
<span><span class="co">## te(temp,month):trendtrend2.1_trend    392</span></span>
<span><span class="co">## te(temp,month):trendtrend2.2_trend    428</span></span>
<span><span class="co">## te(temp,month):trendtrend2.3_trend    868</span></span>
<span><span class="co">## te(temp,month):trendtrend2.4_trend    522</span></span>
<span><span class="co">## te(temp,month):trendtrend2.5_trend    544</span></span>
<span><span class="co">## te(temp,month):trendtrend2.6_trend    815</span></span>
<span><span class="co">## te(temp,month):trendtrend2.7_trend    530</span></span>
<span><span class="co">## te(temp,month):trendtrend2.8_trend    798</span></span>
<span><span class="co">## te(temp,month):trendtrend2.9_trend    322</span></span>
<span><span class="co">## te(temp,month):trendtrend2.10_trend   434</span></span>
<span><span class="co">## te(temp,month):trendtrend2.11_trend   886</span></span>
<span><span class="co">## te(temp,month):trendtrend2.12_trend   900</span></span>
<span><span class="co">## te(temp,month):trendtrend2.13_trend   814</span></span>
<span><span class="co">## te(temp,month):trendtrend2.14_trend   753</span></span>
<span><span class="co">## te(temp,month):trendtrend2.15_trend   778</span></span>
<span><span class="co">## te(temp,month):trendtrend3.1_trend    486</span></span>
<span><span class="co">## te(temp,month):trendtrend3.2_trend    462</span></span>
<span><span class="co">## te(temp,month):trendtrend3.3_trend    679</span></span>
<span><span class="co">## te(temp,month):trendtrend3.4_trend    483</span></span>
<span><span class="co">## te(temp,month):trendtrend3.5_trend    273</span></span>
<span><span class="co">## te(temp,month):trendtrend3.6_trend    502</span></span>
<span><span class="co">## te(temp,month):trendtrend3.7_trend    435</span></span>
<span><span class="co">## te(temp,month):trendtrend3.8_trend    538</span></span>
<span><span class="co">## te(temp,month):trendtrend3.9_trend    234</span></span>
<span><span class="co">## te(temp,month):trendtrend3.10_trend   195</span></span>
<span><span class="co">## te(temp,month):trendtrend3.11_trend   578</span></span>
<span><span class="co">## te(temp,month):trendtrend3.12_trend   585</span></span>
<span><span class="co">## te(temp,month):trendtrend3.13_trend   443</span></span>
<span><span class="co">## te(temp,month):trendtrend3.14_trend   602</span></span>
<span><span class="co">## te(temp,month):trendtrend3.15_trend   915</span></span>
<span><span class="co">## te(temp,month):trendtrend4.1_trend    570</span></span>
<span><span class="co">## te(temp,month):trendtrend4.2_trend    605</span></span>
<span><span class="co">## te(temp,month):trendtrend4.3_trend    407</span></span>
<span><span class="co">## te(temp,month):trendtrend4.4_trend    915</span></span>
<span><span class="co">## te(temp,month):trendtrend4.5_trend    586</span></span>
<span><span class="co">## te(temp,month):trendtrend4.6_trend    561</span></span>
<span><span class="co">## te(temp,month):trendtrend4.7_trend    613</span></span>
<span><span class="co">## te(temp,month):trendtrend4.8_trend    412</span></span>
<span><span class="co">## te(temp,month):trendtrend4.9_trend    429</span></span>
<span><span class="co">## te(temp,month):trendtrend4.10_trend   497</span></span>
<span><span class="co">## te(temp,month):trendtrend4.11_trend   507</span></span>
<span><span class="co">## te(temp,month):trendtrend4.12_trend   353</span></span>
<span><span class="co">## te(temp,month):trendtrend4.13_trend   452</span></span>
<span><span class="co">## te(temp,month):trendtrend4.14_trend   535</span></span>
<span><span class="co">## te(temp,month):trendtrend4.15_trend   632</span></span>
<span><span class="co">## te(temp,month):trendtrend5.1_trend    524</span></span>
<span><span class="co">## te(temp,month):trendtrend5.2_trend    630</span></span>
<span><span class="co">## te(temp,month):trendtrend5.3_trend    428</span></span>
<span><span class="co">## te(temp,month):trendtrend5.4_trend    468</span></span>
<span><span class="co">## te(temp,month):trendtrend5.5_trend    329</span></span>
<span><span class="co">## te(temp,month):trendtrend5.6_trend    547</span></span>
<span><span class="co">## te(temp,month):trendtrend5.7_trend    454</span></span>
<span><span class="co">## te(temp,month):trendtrend5.8_trend    617</span></span>
<span><span class="co">## te(temp,month):trendtrend5.9_trend    541</span></span>
<span><span class="co">## te(temp,month):trendtrend5.10_trend   234</span></span>
<span><span class="co">## te(temp,month):trendtrend5.11_trend   538</span></span>
<span><span class="co">## te(temp,month):trendtrend5.12_trend  1060</span></span>
<span><span class="co">## te(temp,month):trendtrend5.13_trend  1255</span></span>
<span><span class="co">## te(temp,month):trendtrend5.14_trend   362</span></span>
<span><span class="co">## te(temp,month):trendtrend5.15_trend   567</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## GAM process smoothing parameter (rho) estimates:</span></span>
<span><span class="co">##                                               2.5%       50%    97.5% Rhat</span></span>
<span><span class="co">## te(temp,month)_rho_trend                1.52018450  3.316735 4.225933 1.00</span></span>
<span><span class="co">## te(temp,month)2_rho_trend              -0.07375045  2.300555 3.969020 1.02</span></span>
<span><span class="co">## te(temp,month)3_rho_trend              -0.67384587  2.074115 3.990929 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend1_rho_trend   0.48923058  2.684400 4.006977 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend12_rho_trend -2.22093250 -0.502005 2.824346 1.02</span></span>
<span><span class="co">## te(temp,month):seriestrend13_rho_trend -1.58880125  2.508325 4.054055 1.05</span></span>
<span><span class="co">## te(temp,month):seriestrend2_rho_trend   1.11012225  3.115165 4.179771 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend22_rho_trend  1.18384150  3.157635 4.167201 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend23_rho_trend  0.95027112  3.125050 4.178380 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend3_rho_trend   1.48279450  3.207315 4.184309 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend32_rho_trend  0.49551505  2.892235 4.106666 1.02</span></span>
<span><span class="co">## te(temp,month):seriestrend33_rho_trend  0.50766173  3.090635 4.163463 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend4_rho_trend   1.34355250  3.188770 4.182075 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend42_rho_trend  0.56057818  3.033990 4.119350 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend43_rho_trend  0.11450175  3.062945 4.165412 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend5_rho_trend   0.80465620  3.145535 4.143281 1.00</span></span>
<span><span class="co">## te(temp,month):seriestrend52_rho_trend -0.30574052  2.038070 3.910541 1.01</span></span>
<span><span class="co">## te(temp,month):seriestrend53_rho_trend  0.67168060  3.067810 4.139428 1.01</span></span>
<span><span class="co">##                                        n.eff</span></span>
<span><span class="co">## te(temp,month)_rho_trend                 720</span></span>
<span><span class="co">## te(temp,month)2_rho_trend                235</span></span>
<span><span class="co">## te(temp,month)3_rho_trend                337</span></span>
<span><span class="co">## te(temp,month):seriestrend1_rho_trend    631</span></span>
<span><span class="co">## te(temp,month):seriestrend12_rho_trend   201</span></span>
<span><span class="co">## te(temp,month):seriestrend13_rho_trend   162</span></span>
<span><span class="co">## te(temp,month):seriestrend2_rho_trend    568</span></span>
<span><span class="co">## te(temp,month):seriestrend22_rho_trend   736</span></span>
<span><span class="co">## te(temp,month):seriestrend23_rho_trend   780</span></span>
<span><span class="co">## te(temp,month):seriestrend3_rho_trend   1077</span></span>
<span><span class="co">## te(temp,month):seriestrend32_rho_trend   298</span></span>
<span><span class="co">## te(temp,month):seriestrend33_rho_trend   593</span></span>
<span><span class="co">## te(temp,month):seriestrend4_rho_trend    820</span></span>
<span><span class="co">## te(temp,month):seriestrend42_rho_trend   396</span></span>
<span><span class="co">## te(temp,month):seriestrend43_rho_trend   291</span></span>
<span><span class="co">## te(temp,month):seriestrend5_rho_trend    591</span></span>
<span><span class="co">## te(temp,month):seriestrend52_rho_trend   297</span></span>
<span><span class="co">## te(temp,month):seriestrend53_rho_trend   666</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Stan MCMC diagnostics:</span></span>
<span><span class="co">## n_eff / iter looks reasonable for all parameters</span></span>
<span><span class="co">## Rhats above 1.05 found for 62 parameters</span></span>
<span><span class="co">## *Diagnose further to investigate why the chains have not mixed</span></span>
<span><span class="co">## 0 of 2000 iterations ended with a divergence (0%)</span></span>
<span><span class="co">## 0 of 2000 iterations saturated the maximum tree depth of 12 (0%)</span></span>
<span><span class="co">## Chain 1: E-FMI = 0.1843</span></span>
<span><span class="co">## Chain 2: E-FMI = 0.1477</span></span>
<span><span class="co">## Chain 4: E-FMI = 0.1519</span></span>
<span><span class="co">## *E-FMI below 0.2 indicates you may need to reparameterize your model</span></span></code></pre>
<p>The convergence of this model isn’t fabulous (more on this in a
moment). But we can again plot the smooth functions, which this time
operate on the process model. We can see the same plot using
<code>trend_effects = TRUE</code> in the plotting functions:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, <span class="st">'smooths'</span>, trend_effects <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-33-1.png" width="60%" style="display: block; margin: auto;"><img src="trend_formulas_files/figure-html/unnamed-chunk-33-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>The VAR matrix is of particular interest here, as it captures lagged
dependencies and cross-dependencies in the latent process model:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, variable <span class="op">=</span> <span class="st">'A'</span>, regex <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-34-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Unfortunately <code>bayesplot</code> doesn’t know this is a matrix of
parameters so what we see is actually the transpose of the VAR matrix. A
little bit of wrangling gives us these histograms in the correct
order:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">A_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'A['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-35-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>There is a lot happening in this matrix. Each cell captures the
lagged effect of the process in the column on the process in the row in
the next timestep. So for example, the effect in cell [3,1], which is
quite strongly negative, means that an <em>increase</em> in the process
for series 3 (Greens) at time <span class="math inline">\(t\)</span> is
expected to lead to a subsequent <em>decrease</em> in the process for
series 1 (Bluegreens) at time <span class="math inline">\(t+1\)</span>.
The latent process model is now capturing these effects and the smooth
seasonal effects, so the trend plot shows our best estimate of what the
<em>true</em> count should have been at each time point:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-36-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'trend'</span>, series <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-37-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The process error <span class="math inline">\((\Sigma)\)</span>
captures unmodelled variation in the process models. Again, we fixed the
off-diagonals to 0, so the histograms for these will look like flat
boxes:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Sigma_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sigma['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Sigma_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-38-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The observation error estimates <span class="math inline">\((\sigma_{obs})\)</span> represent how much the
model thinks we might miss the true count when we take our imperfect
measurements:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, variable <span class="op">=</span> <span class="st">'sigma_obs'</span>, regex <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-39-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>These are still a bit hard to identify overall.</p>
</div>
<div class="section level3">
<h3 id="correlated-process-errors">Correlated process errors<a class="anchor" aria-label="anchor" href="#correlated-process-errors"></a>
</h3>
<p>Let’s see if the estimates improve when we allow the process errors
to be correlated. Once again, we need to first update the priors for the
observation errors:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">priors</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span></span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with correlated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1cor'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># update the sigma_obs prior so that it avoids very small</span></span>
<span><span class="co"># and very large values that are nonsensical</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">prior</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"sigma_obs ~ uniform(0.1, 1);"</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_lowerbound</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">priors</span><span class="op">$</span><span class="va">new_upperbound</span><span class="op">[</span><span class="fl">11</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>And now we can fit the correlated process error model.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">varcor_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span>  </span>
<span>  <span class="co"># observation formula, which just uses an intercept</span></span>
<span>  <span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>  </span>
<span>  <span class="co"># process model formula, which includes the smooth functions</span></span>
<span>  trend_formula <span class="op">=</span> <span class="op">~</span> <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">te</span><span class="op">(</span><span class="va">temp</span>, <span class="va">month</span>, k <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">trend</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="co"># VAR1 model with correlated process errors</span></span>
<span>  trend_model <span class="op">=</span> <span class="st">'VAR1cor'</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">plankton_train</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">plankton_test</span>,</span>
<span>  </span>
<span>  <span class="co"># include the updated priors</span></span>
<span>  priors <span class="op">=</span> <span class="va">priors</span><span class="op">)</span></span></code></pre></div>
<p>Plot convergence diagnostics for the two models, which shows that the
more complex model with correlated errors has better convergence:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'rhat'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">'VAR1cor'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-42-1.png" width="60%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'rhat'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="st">'VAR1'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-42-2.png" width="60%" style="display: block; margin: auto;"></p>
<p>We can also check convergence using one of the package’s inbuilt
utility functions:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mvgam</span><span class="fu">:::</span><span class="fu">check_rhat</span><span class="op">(</span><span class="va">varcor_mod</span><span class="op">$</span><span class="va">model_output</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rhats above 1.05 found for 18 parameters</span></span>
<span><span class="co">## *Diagnose further to investigate why the chains have not mixed</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">mvgam</span><span class="fu">:::</span><span class="fu">check_rhat</span><span class="op">(</span><span class="va">var_mod</span><span class="op">$</span><span class="va">model_output</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rhats above 1.05 found for 62 parameters</span></span>
<span><span class="co">## *Diagnose further to investigate why the chains have not mixed</span></span></code></pre>
<p>This model has converged better than the first model (that assumed
process errors were independent), possibly telling us that this is a
more appropriate model. The <span class="math inline">\((\Sigma)\)</span> matrix now captures any evidence
of contemporaneously correlated process error:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">Sigma_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'Sigma['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">varcor_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">Sigma_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-44-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>This symmetric matrix tells us there is support for correlated
process errors. For example, series 1 and 3 (Bluegreens and Greens) show
negatively correlated process errors, while series 1 and 4 (Bluegreens
and Other.algae) show positively correlated errors. But it is easier to
interpret these estimates if we convert the covariance matrix to a
correlation matrix. Here we compute the posterior median process error
correlations:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Sigma_post</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">varcor_mod</span>, variable <span class="op">=</span> <span class="st">'Sigma'</span>, regex <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">median_correlations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">Sigma_post</span>, <span class="fl">2</span>, <span class="va">median</span><span class="op">)</span>,</span>
<span>                                      nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">median_correlations</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">median_correlations</span><span class="op">)</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">plankton_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">median_correlations</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             Bluegreens Diatoms Greens Other.algae Unicells</span></span>
<span><span class="co">## Bluegreens        1.00    0.16  -0.17        0.40     0.13</span></span>
<span><span class="co">## Diatoms           0.16    1.00   0.01        0.42     0.03</span></span>
<span><span class="co">## Greens           -0.17    0.01   1.00        0.15     0.44</span></span>
<span><span class="co">## Other.algae       0.40    0.42   0.15        1.00     0.28</span></span>
<span><span class="co">## Unicells          0.13    0.03   0.44        0.28     1.00</span></span></code></pre>
<p>Because this model is able to capture correlated errors, the VAR
matrix has changed slightly:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">5</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">A_pars</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'A['</span>, <span class="va">i</span>, <span class="st">','</span>, <span class="va">j</span>, <span class="st">']'</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mcmc_plot</span><span class="op">(</span><span class="va">varcor_mod</span>, </span>
<span>          variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">A_pars</span><span class="op">)</span><span class="op">)</span>, </span>
<span>          type <span class="op">=</span> <span class="st">'hist'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-46-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>We still have some evidence of lagged cross-dependence, but some of
these interactions have now been pulled more toward zero. But which
model is better? Forecasts don’t appear to differ very much, at least
qualitatively (here are forecasts for three of the series, for each
model):</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-47-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 2.995416</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">1</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-48-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 3.137511</span></span></code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">2</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-49-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 6.100556</span></span></code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">2</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-50-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 5.92898</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">var_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">3</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-51-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 4.132173</span></span></code></pre>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">varcor_mod</span>, type <span class="op">=</span> <span class="st">'forecast'</span>, series <span class="op">=</span> <span class="fl">3</span>, newdata <span class="op">=</span> <span class="va">plankton_test</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-52-1.png" width="60%" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">## Out of sample CRPS:</span></span>
<span><span class="co">## [1] 4.127152</span></span></code></pre>
<p>We can compute the variogram score for out of sample forecasts to get
a sense of which model does a better job of capturing the dependence
structure in the true evaluation set:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create forecast objects for each model</span></span>
<span><span class="va">fcvar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">var_mod</span><span class="op">)</span></span>
<span><span class="va">fcvarcor</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forecast.mvgam.html">forecast</a></span><span class="op">(</span><span class="va">varcor_mod</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot the difference in variogram scores; a negative value means the VAR1cor model is better, while a positive value means the VAR1 model is better</span></span>
<span><span class="va">diff_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvarcor</span>, score <span class="op">=</span> <span class="st">'variogram'</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span> <span class="op">-</span></span>
<span>  <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvar</span>, score <span class="op">=</span> <span class="st">'variogram'</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diff_scores</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.25</span>, col <span class="op">=</span> <span class="st">'darkred'</span>, </span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     bty <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">'Forecast horizon'</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">variogram</span><span class="op">[</span><span class="va">VAR1cor</span><span class="op">]</span><span class="op">~</span><span class="op">-</span><span class="op">~</span><span class="va">variogram</span><span class="op">[</span><span class="va">VAR1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-53-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>And we can also compute the energy score for out of sample forecasts
to get a sense of which model provides forecasts that are better
calibrated:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot the difference in energy scores; a negative value means the VAR1cor model is better, while a positive value means the VAR1 model is better</span></span>
<span><span class="va">diff_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvarcor</span>, score <span class="op">=</span> <span class="st">'energy'</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span> <span class="op">-</span></span>
<span>  <span class="fu"><a href="../reference/score.mvgam_forecast.html">score</a></span><span class="op">(</span><span class="va">fcvar</span>, score <span class="op">=</span> <span class="st">'energy'</span><span class="op">)</span><span class="op">$</span><span class="va">all_series</span><span class="op">$</span><span class="va">score</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">diff_scores</span>, pch <span class="op">=</span> <span class="fl">16</span>, cex <span class="op">=</span> <span class="fl">1.25</span>, col <span class="op">=</span> <span class="st">'darkred'</span>, </span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">diff_scores</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     bty <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">'Forecast horizon'</span>,</span>
<span>     ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">energy</span><span class="op">[</span><span class="va">VAR1cor</span><span class="op">]</span><span class="op">~</span><span class="op">-</span><span class="op">~</span><span class="va">energy</span><span class="op">[</span><span class="va">VAR1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span></code></pre></div>
<p><img src="trend_formulas_files/figure-html/unnamed-chunk-54-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>The models tend to provide similar forecasts, so we would probably
need to use a more extensive rolling forecast evaluation exercise if we
felt like we needed to only choose one for production.
<code>mvgam</code> offers some utilities for doing this (i.e. see
<code><a href="../reference/lfo_cv.mvgam.html">?lfo_cv</a></code> for guidance).</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Nicholas J Clark.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
