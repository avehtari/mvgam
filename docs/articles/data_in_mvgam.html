<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mvgam">
<title>Formatting data for use in mvgam • mvgam</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Formatting data for use in mvgam">
<meta property="og:description" content="mvgam">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mvgam</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data_in_mvgam.html">Formatting data for use in mvgam</a>
    <a class="dropdown-item" href="../articles/mvgam_overview.html">Overview of the mvgam package</a>
    <a class="dropdown-item" href="../articles/trend_formulas.html">State-Space models in the mvgam package</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/nicholasjclark/mvgam/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Formatting data for use in mvgam</h1>
                        <h4 data-toc-skip class="author">Nicholas J
Clark</h4>
            
            <h4 data-toc-skip class="date">2023-09-20</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasjclark/mvgam/blob/HEAD/vignettes/data_in_mvgam.Rmd" class="external-link"><code>vignettes/data_in_mvgam.Rmd</code></a></small>
      <div class="d-none name"><code>data_in_mvgam.Rmd</code></div>
    </div>

    
    
<p>This vignette gives an example of how to take raw data and format it
for use in <code>mvgam</code>. This is not an exhaustive example, as
data can be recorded and stored in a variety of ways, which requires
different approaches to wrangle the data into the necessary format for
<code>mvgam</code>. For full details on the basic <code>mvgam</code>
functionality, please see <a href="https://nicholasjclark.github.io/mvgam/articles/mvgam_overview.html">the
introductory vignette</a>.</p>
<div class="section level2">
<h2 id="required-long-data-format">Required <em>long</em> data format<a class="anchor" aria-label="anchor" href="#required-long-data-format"></a>
</h2>
<p>Manipulating the data into a ‘long’ format is necessary for modelling
in <code>mvgam</code>. By ‘long’ format, we mean that each
<code>series x time</code> observation needs to have its own entry in
the <code>dataframe</code> or <code>list</code> object that we wish to
use as data for modelling. A simple example can be viewed by simulating
data using the <code>sim_mvgam</code> function. See
<code><a href="../reference/sim_mvgam.html">?sim_mvgam</a></code> for more details</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_mvgam.html">sim_mvgam</a></span><span class="op">(</span>n_series <span class="op">=</span> <span class="fl">4</span>, T <span class="op">=</span> <span class="fl">24</span>, prop_missing <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>, <span class="fl">16</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     y season year   series time</span></span>
<span><span class="co">## 1  10      1    1 series_1    1</span></span>
<span><span class="co">## 2  NA      1    1 series_2    1</span></span>
<span><span class="co">## 3  13      1    1 series_3    1</span></span>
<span><span class="co">## 4   6      1    1 series_4    1</span></span>
<span><span class="co">## 5   4      2    1 series_1    2</span></span>
<span><span class="co">## 6   2      2    1 series_2    2</span></span>
<span><span class="co">## 7   3      2    1 series_3    2</span></span>
<span><span class="co">## 8   0      2    1 series_4    2</span></span>
<span><span class="co">## 9   4      3    1 series_1    3</span></span>
<span><span class="co">## 10 NA      3    1 series_2    3</span></span>
<span><span class="co">## 11  0      3    1 series_3    3</span></span>
<span><span class="co">## 12 NA      3    1 series_4    3</span></span>
<span><span class="co">## 13  9      4    1 series_1    4</span></span>
<span><span class="co">## 14  4      4    1 series_2    4</span></span>
<span><span class="co">## 15  7      4    1 series_3    4</span></span>
<span><span class="co">## 16 NA      4    1 series_4    4</span></span></code></pre>
<div class="section level3">
<h3 id="series-as-a-factor-variable">
<code>series</code> as a <code>factor</code> variable<a class="anchor" aria-label="anchor" href="#series-as-a-factor-variable"></a>
</h3>
<p>Notice how we have four different time series in these simulated
data, and we have identified the series-level indicator as a
<code>factor</code> variable.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "factor"</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "series_1" "series_2" "series_3" "series_4"</span></span></code></pre>
<p>It is important that the number of levels matches the number of
unique series in the data to ensure indexing across series works
properly in the underlying modelling functions. Several of the main
workhorse functions in the package (including <code><a href="../reference/mvgam.html">mvgam()</a></code> and
<code><a href="../reference/get_mvgam_priors.html">get_mvgam_priors()</a></code>) will give an error if this is not the
case, but it may be worth checking anyway:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Note that you can technically supply data that does not have a
<code>series</code> indicator, and the package will assume that you are
only using a single time series. But again, it is better to have this
included so there is no confusion.</p>
</div>
<div class="section level3">
<h3 id="a-single-outcome-variable">A single outcome variable<a class="anchor" aria-label="anchor" href="#a-single-outcome-variable"></a>
</h3>
<p>You may also have notices that we do not spread the
<code>numeric / integer</code>-classed outcome variable into different
columns. Rather, there is only a single column for the outcome variable,
labelled <code>y</code> in these simulated data (though the outcome does
not have to be labelled <code>y</code>). This is another important
requirement in <code>mvgam</code>, but it shouldn’t be too unfamiliar to
<code>R</code> users who frequently use modelling packages such as
<code>lme4</code>, <code>mgcv</code>, <code>brms</code> or the many
other regression modelling packages out there. The advantage of this
format is that it is now very easy to specify effects that vary among
time series:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">series</span> <span class="op">+</span> <span class="va">time</span>,</span>
<span>            data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## glm(formula = y ~ series + time, family = poisson(), data = simdat$data_train)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Deviance Residuals: </span></span>
<span><span class="co">##     Min       1Q   Median       3Q      Max  </span></span>
<span><span class="co">## -2.7037  -1.7616  -0.8752   0.6520   3.6985  </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Coefficients:</span></span>
<span><span class="co">##                Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">## (Intercept)     1.28034    0.19610   6.529 6.61e-11 ***</span></span>
<span><span class="co">## seriesseries_2 -0.19845    0.22490  -0.882  0.37756    </span></span>
<span><span class="co">## seriesseries_3  0.06594    0.20320   0.325  0.74554    </span></span>
<span><span class="co">## seriesseries_4 -0.66950    0.25906  -2.584  0.00976 ** </span></span>
<span><span class="co">## time           -0.01673    0.01626  -1.029  0.30353    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## (Dispersion parameter for poisson family taken to be 1)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     Null deviance: 193.91  on 57  degrees of freedom</span></span>
<span><span class="co">## Residual deviance: 181.82  on 53  degrees of freedom</span></span>
<span><span class="co">##   (14 observations deleted due to missingness)</span></span>
<span><span class="co">## AIC: 311.94</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Number of Fisher Scoring iterations: 5</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu">gam</span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">series</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">time</span>, by <span class="op">=</span> <span class="va">series</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: poisson </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## y ~ series + s(time, by = series)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##                Estimate Std. Error z value Pr(&gt;|z|)</span></span>
<span><span class="co">## (Intercept)      0.4529     0.2906   1.559    0.119</span></span>
<span><span class="co">## seriesseries_2  -0.1655     0.4531  -0.365    0.715</span></span>
<span><span class="co">## seriesseries_3   0.2541     0.3684   0.690    0.490</span></span>
<span><span class="co">## seriesseries_4  -3.0260     2.3425  -1.292    0.196</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##                          edf Ref.df Chi.sq p-value    </span></span>
<span><span class="co">## s(time):seriesseries_1 7.052  7.993 25.222 0.00136 ** </span></span>
<span><span class="co">## s(time):seriesseries_2 7.659  8.383 19.077 0.04327 *  </span></span>
<span><span class="co">## s(time):seriesseries_3 8.515  8.932 37.134 2.3e-05 ***</span></span>
<span><span class="co">## s(time):seriesseries_4 8.637  8.948  9.375 0.39795    </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.792   Deviance explained = 86.8%</span></span>
<span><span class="co">## UBRE = 0.67868  Scale est. = 1         n = 58</span></span></code></pre>
<p>Depending on the observation families you plan to use when building
models, there may be some restrictions that need to be satisfied within
the outcome variable. For example, a Beta regression can only handle
proportional data, so values <code>&gt;= 1</code> or
<code>&lt;= 0</code> are not allowed. Likewise, a Poisson regression can
only handle non-negative integers. Most regression functions in
<code>R</code> will assume the user knows all of this and so will not
issue any warnings or errors if you choose the wrong distribution, but
often this ends up leading to some unhelpful error from an optimizer
that is difficult to interpret and diagnose. <code>mvgam</code> will
attempt to provide some errors if you do something that is simply not
allowed. For example, we can simulate data from a zero-centred Gaussian
distribution (ensuring that some of our values will be
<code>&lt; 1</code>) and attempt a Beta regression in <code>mvgam</code>
using the <code>betar</code> family:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gauss_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                        series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">'series1'</span>,</span>
<span>                                        levels <span class="op">=</span> <span class="st">'series1'</span><span class="op">)</span>,</span>
<span>                        time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">gauss_dat</span></span></code></pre></div>
<pre><code><span><span class="co">##       outcome  series time</span></span>
<span><span class="co">## 1   1.4518774 series1    1</span></span>
<span><span class="co">## 2   0.7909187 series1    2</span></span>
<span><span class="co">## 3   0.5600856 series1    3</span></span>
<span><span class="co">## 4   1.1257856 series1    4</span></span>
<span><span class="co">## 5   0.5219366 series1    5</span></span>
<span><span class="co">## 6   0.2520088 series1    6</span></span>
<span><span class="co">## 7   1.1663208 series1    7</span></span>
<span><span class="co">## 8  -0.4156534 series1    8</span></span>
<span><span class="co">## 9  -1.2177150 series1    9</span></span>
<span><span class="co">## 10  0.5216225 series1   10</span></span></code></pre>
<p>A call to <code>gam</code> using the <code>mgcv</code> package leads
to a model that actually fits (though it does give an unhelpful warning
message):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">gam</span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">time</span>,</span>
<span>    family <span class="op">=</span> <span class="fu">betar</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">gauss_dat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in family$saturated.ll(y, prior.weights, theta): saturated likelihood</span></span>
<span><span class="co">## may be inaccurate</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: Beta regression(0.169) </span></span>
<span><span class="co">## Link function: logit </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## outcome ~ time</span></span>
<span><span class="co">## Total model degrees of freedom 2 </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## REML score: -120.5983</span></span></code></pre>
<p>But the same call to <code>mvgam</code> gives us something more
useful:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">time</span>,</span>
<span>      family <span class="op">=</span> <span class="fu">betar</span><span class="op">(</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">gauss_dat</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Values &lt;= 0 not allowed for beta responses</span></span></code></pre>
<p>Please see <code><a href="../reference/mvgam_families.html">?mvgam_families</a></code> for more information on the
types of responses that the package can handle and their
restrictions</p>
</div>
<div class="section level3">
<h3 id="a-time-variable">A <code>time</code> variable<a class="anchor" aria-label="anchor" href="#a-time-variable"></a>
</h3>
<p>The other requirement for modelling in <code>mvgam</code> is a
<code>numeric / integer</code>-classed variable labelled
<code>time</code> to ensure the modelling software knows how to arrange
the time series when building models. This setup still allows us to
formulate multivariate time series models. If you plan to use any of the
autoregressive dynamic trend functions available in <code>mvgam</code>
(see <code><a href="../reference/mvgam_trends.html">?mvgam_trends</a></code> for details of available dynamic
processes), you will need to ensure your time series are entered with a
fixed sampling interval (i.e. the time between timesteps 1 and 2 should
be the same as the time between timesteps 2 and 3, etc…). But note that
you can have missing observations for some (or all) series.
<code>mvgam</code> will check this for you, but again it is useful to
ensure you have no missing timepoint x series combinations in your data.
You can generally do this with a simple <code>dplyr</code> call:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A function to ensure all timepoints within a sequence are identical</span></span>
<span><span class="va">all_times_avail</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, <span class="va">min_time</span>, <span class="va">max_time</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">min_time</span>, to <span class="op">=</span> <span class="va">max_time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Get min and max times from the data</span></span>
<span><span class="va">min_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="va">max_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check that all times are recorded for each series</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>series <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">series</span>,</span>
<span>           time <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span><span class="op">$</span><span class="va">time</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>all_there <span class="op">=</span> <span class="fu">all_times_avail</span><span class="op">(</span><span class="va">time</span>,</span>
<span>                                                 <span class="va">min_time</span>,</span>
<span>                                                 <span class="va">max_time</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">checked_times</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">checked_times</span><span class="op">$</span><span class="va">all_there</span> <span class="op">==</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"One or more series in is missing observations for one or more timepoints"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">'All series have observations at all timepoints :)'</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## All series have observations at all timepoints :)</span></span></code></pre>
<p>Note that models which use dynamic components will assume that
smaller values of <code>time</code> are <em>older</em>
(i.e. <code>time = 1</code> came <em>before</em> <code>time = 2</code>,
etc…)</p>
</div>
</div>
<div class="section level2">
<h2 id="checking-data-with-get_mvgam_priors">Checking data with <code>get_mvgam_priors</code><a class="anchor" aria-label="anchor" href="#checking-data-with-get_mvgam_priors"></a>
</h2>
<p>The <code>get_mvgam_priors</code> function is designed to return
information about the parameters in a model whose prior distributions
can be modified by the user. But in doing so, it will perform a series
of checks to ensure the data are formatted properly. It can therefore be
very useful to new users for ensuring there isn’t anything strange going
on in the data setup. For example, we can replicate the steps taken
above (to check factor levels and timepoint x series combinations) with
a single call to <code>get_mvgam_priors</code>. Here we first simulate
some data in which some of the timepoints in the <code>time</code>
variable are not included in the data:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">16</span>, by <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                        series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">'series_1'</span><span class="op">)</span>,</span>
<span>                        outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bad_times</span></span></code></pre></div>
<pre><code><span><span class="co">##   time   series     outcome</span></span>
<span><span class="co">## 1    1 series_1  2.20017302</span></span>
<span><span class="co">## 2    3 series_1  1.17415246</span></span>
<span><span class="co">## 3    5 series_1  1.90125966</span></span>
<span><span class="co">## 4    7 series_1  0.02701025</span></span>
<span><span class="co">## 5    9 series_1  0.15529913</span></span>
<span><span class="co">## 6   11 series_1 -1.06454999</span></span>
<span><span class="co">## 7   13 series_1 -1.48912904</span></span>
<span><span class="co">## 8   15 series_1 -1.04876154</span></span></code></pre>
<p>Next we call <code>get_mvgam_priors</code> by simply specifying an
intercept-only model, which is enough to trigger all the checks:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">bad_times</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: One or more series in data is missing observations for one or more timepoints</span></span></code></pre>
<p>This error is useful as it tells us where the problem is. There are
many ways to fill in missing timepoints, so the correct way will have to
be left up to the user. But if you don’t have any covariates, it should
be pretty easy using <code>expand.grid</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_times</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>,</span>
<span>                                           <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">series</span><span class="op">)</span>,</span>
<span>                                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">bad_times</span><span class="op">$</span><span class="va">series</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">good_times</span></span></code></pre></div>
<pre><code><span><span class="co">## Joining, by = c("time", "series")</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">good_times</span></span></code></pre></div>
<pre><code><span><span class="co">##    time   series     outcome</span></span>
<span><span class="co">## 1     1 series_1  2.20017302</span></span>
<span><span class="co">## 2     2 series_1          NA</span></span>
<span><span class="co">## 3     3 series_1  1.17415246</span></span>
<span><span class="co">## 4     4 series_1          NA</span></span>
<span><span class="co">## 5     5 series_1  1.90125966</span></span>
<span><span class="co">## 6     6 series_1          NA</span></span>
<span><span class="co">## 7     7 series_1  0.02701025</span></span>
<span><span class="co">## 8     8 series_1          NA</span></span>
<span><span class="co">## 9     9 series_1  0.15529913</span></span>
<span><span class="co">## 10   10 series_1          NA</span></span>
<span><span class="co">## 11   11 series_1 -1.06454999</span></span>
<span><span class="co">## 12   12 series_1          NA</span></span>
<span><span class="co">## 13   13 series_1 -1.48912904</span></span>
<span><span class="co">## 14   14 series_1          NA</span></span>
<span><span class="co">## 15   15 series_1 -1.04876154</span></span></code></pre>
<p>Now the call to <code>get_mvgam_priors</code>, using our filled in
data, should work:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">good_times</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                             param_name param_length           param_info</span></span>
<span><span class="co">## 1                          (Intercept)            1          (Intercept)</span></span>
<span><span class="co">## 2 vector&lt;lower=0&gt;[n_series] sigma_obs;            1 observation error sd</span></span>
<span><span class="co">##                                 prior                   example_change</span></span>
<span><span class="co">## 1 (Intercept) ~ student_t(3, 0, 2.5);      (Intercept) ~ normal(0, 1);</span></span>
<span><span class="co">## 2   sigma_obs ~ student_t(3, 0, 2.5); sigma_obs ~ normal(-0.08, 0.18);</span></span>
<span><span class="co">##   new_lowerbound new_upperbound</span></span>
<span><span class="co">## 1             NA             NA</span></span>
<span><span class="co">## 2             NA             NA</span></span></code></pre>
<p>This function should also pick up on misaligned factor levels for the
<code>series</code> variable. We can check this by again simulating,
this time adding an additional factor level that is not included in the
data:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">8</span>,</span>
<span>                        series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">'series_1'</span>,</span>
<span>                                        levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'series_1'</span>,</span>
<span>                                                   <span class="st">'series_2'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">bad_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "series_1" "series_2"</span></span></code></pre>
<p>Another call to <code>get_mvgam_priors</code> brings up a useful
error:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">bad_levels</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Mismatch between factor levels of "series" and unique values of "series"</span></span>
<span><span class="co">## Use</span></span>
<span><span class="co">##   `setdiff(levels(data$series), unique(data$series))` </span></span>
<span><span class="co">## and</span></span>
<span><span class="co">##   `intersect(levels(data$series), unique(data$series))`</span></span>
<span><span class="co">## for guidance</span></span></code></pre>
<p>Following the message’s advice tells us there is a level for
<code>series_2</code> in the <code>series</code> variable, but there are
no observations for this series in the data:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">bad_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">bad_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "series_2"</span></span></code></pre>
<p>Re-assigning the levels fixes the issue:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_levels</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">good_levels</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">good_levels</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "series_1"</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">good_levels</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                             param_name param_length           param_info</span></span>
<span><span class="co">## 1                          (Intercept)            1          (Intercept)</span></span>
<span><span class="co">## 2 vector&lt;lower=0&gt;[n_series] sigma_obs;            1 observation error sd</span></span>
<span><span class="co">##                                    prior                  example_change</span></span>
<span><span class="co">## 1 (Intercept) ~ student_t(3, -0.6, 2.5);     (Intercept) ~ normal(0, 1);</span></span>
<span><span class="co">## 2      sigma_obs ~ student_t(3, 0, 2.5); sigma_obs ~ normal(0.52, 0.57);</span></span>
<span><span class="co">##   new_lowerbound new_upperbound</span></span>
<span><span class="co">## 1             NA             NA</span></span>
<span><span class="co">## 2             NA             NA</span></span></code></pre>
<div class="section level3">
<h3 id="covariates-with-no-nas">Covariates with no <code>NA</code>s<a class="anchor" aria-label="anchor" href="#covariates-with-no-nas"></a>
</h3>
<p>Covariates can be used in models just as you would when using
<code>mgcv</code> (see <code>?formula.gam</code> for details of the
formula syntax). But although the outcome variable can have
<code>NA</code>s, covariates cannot. Most regression software will
silently drop any raws in the model matrix that have <code>NA</code>s,
which is not helpful when debugging. Both the <code>mvgam</code> and
<code>get_mvgam_priors</code> functions will run some simple checks for
you, and hopefully will return useful errors if it finds in missing
values:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">miss_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                       cov <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">'series1'</span>,</span>
<span>                                       levels <span class="op">=</span> <span class="st">'series1'</span><span class="op">)</span>,</span>
<span>                       time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">miss_dat</span></span></code></pre></div>
<pre><code><span><span class="co">##        outcome        cov  series time</span></span>
<span><span class="co">## 1   1.84082730         NA series1    1</span></span>
<span><span class="co">## 2   0.44230371  0.6659689 series1    2</span></span>
<span><span class="co">## 3  -0.01698825  0.6715888 series1    3</span></span>
<span><span class="co">## 4  -0.98516248 -0.5245143 series1    4</span></span>
<span><span class="co">## 5  -1.30131051 -0.1782780 series1    5</span></span>
<span><span class="co">## 6   0.79144304 -1.5080633 series1    6</span></span>
<span><span class="co">## 7  -0.72575780 -0.5069440 series1    7</span></span>
<span><span class="co">## 8   1.21879626  1.5301172 series1    8</span></span>
<span><span class="co">## 9   1.15411215  0.9275405 series1    9</span></span>
<span><span class="co">## 10  0.25047894  0.7677354 series1   10</span></span></code></pre>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">miss_dat</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Missing values found in data predictors:</span></span>
<span><span class="co">##  Error in na.fail.default(structure(list(outcome = c(1.8408273037587, 0.442303711839762, : missing values in object</span></span></code></pre>
<p>Just like with the <code>mgcv</code> package, <code>mvgam</code> can
also accept data as a <code>list</code> object. This is useful if you
want to set up <a href="https://rdrr.io/cran/mgcv/man/linear.functional.terms.html" class="external-link">linear
functional predictors</a> or even distributed lag predictors. The checks
run by <code>mvgam</code> should still work on these data. Here we
change the <code>cov</code> predictor to be a <code>matrix</code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">miss_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>outcome <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                 series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">'series1'</span>,</span>
<span>                                 levels <span class="op">=</span> <span class="st">'series1'</span><span class="op">)</span>,</span>
<span>                 time <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">miss_dat</span><span class="op">$</span><span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">5</span>, nrow <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">miss_dat</span><span class="op">$</span><span class="va">cov</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>A call to <code>mvgam</code> returns the same error:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">~</span> <span class="va">cov</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">miss_dat</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Missing values found in data predictors:</span></span>
<span><span class="co">##  Error in na.fail.default(structure(list(outcome = c(0.378630170365263, : missing values in object</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="plotting-with-plot_mvgam_series">Plotting with <code>plot_mvgam_series</code><a class="anchor" aria-label="anchor" href="#plotting-with-plot_mvgam_series"></a>
</h2>
<p>Plotting the data is a useful way to ensure everything looks ok, once
you’ve gone throug the above checks on factor levels and timepoint x
series combinations. The <code>plot_mvgam_series</code> function will
take supplied data and plot either a series of line plots (if you choose
<code>series = 'all'</code>) or a set of plots to describe the
distribution for a single time series. For example, to plot all of the
time series in our data, and highlight a single series in each plot, we
can use:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>, </span>
<span>                  y <span class="op">=</span> <span class="st">'y'</span>, </span>
<span>                  series <span class="op">=</span> <span class="st">'all'</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_in_mvgam_files/figure-html/unnamed-chunk-23-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>Or we can look more closely at the distribution for the first time
series:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>, </span>
<span>                  y <span class="op">=</span> <span class="st">'y'</span>, </span>
<span>                  series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_in_mvgam_files/figure-html/unnamed-chunk-24-1.png" width="60%" style="display: block; margin: auto;"></p>
<p>If you have split your data into training and testing folds (i.e. for
forecast evaluation), you can include the test data in your plots:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mvgam_series.html">plot_mvgam_series</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_train</span>,</span>
<span>                  newdata <span class="op">=</span> <span class="va">simdat</span><span class="op">$</span><span class="va">data_test</span>,</span>
<span>                  y <span class="op">=</span> <span class="st">'y'</span>, </span>
<span>                  series <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="data_in_mvgam_files/figure-html/unnamed-chunk-25-1.png" width="60%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="example-with-neon-tick-data">Example with NEON tick data<a class="anchor" aria-label="anchor" href="#example-with-neon-tick-data"></a>
</h2>
<p>To give one example of how data can be reformatted for
<code>mvgam</code> modelling, we will use observations from the National
Ecological Observatory Network (NEON) tick drag cloth samples.
<em>Ixodes scapularis</em> is a widespread tick species capable of
transmitting a diversity of parasites to animals and humans, many of
which are zoonotic. Due to the medical and ecological importance of this
tick species, a common goal is to understand factors that influence
their abundances. The NEON field team carries out standardised <a href="https://www.neonscience.org/data-collection/ticks" target="_blank" class="external-link">long-term monitoring of tick abundances as well as other
important indicators of ecological change</a>. Nymphal abundance of
<em>I. scapularis</em> is routinely recorded across NEON plots using a
field sampling method called drag cloth sampling, which is a common
method for sampling ticks in the landscape. Field researchers sample
ticks by dragging a large cloth behind themselves through terrain that
is suspected of harboring ticks, usually working in a grid-like pattern.
The sites have been sampled since 2014, resulting in a rich dataset of
nymph abundance time series. These tick time series show strong
seasonality and incorporate many of the challenging features associated
with ecological data including overdispersion, high proportions of
missingness and irregular sampling in time, making them useful for
exploring the utility of dynamic GAMs.</p>
<p>We begin by loading NEON tick data for the years 2014 - 2021, which
were downloaded from NEON and prepared as described in <a href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13974" target="_blank" class="external-link">Clark &amp; Wells 2022</a>. You can read a bit about the
data using the call <code><a href="../reference/all_neon_tick_data.html">?all_neon_tick_data</a></code></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"all_neon_tick_data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="va">all_neon_tick_data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## tibble [3,505 × 24] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co">##  $ Year                : num [1:3505] 2015 2015 2015 2015 2015 ...</span></span>
<span><span class="co">##  $ epiWeek             : chr [1:3505] "37" "38" "39" "40" ...</span></span>
<span><span class="co">##  $ yearWeek            : chr [1:3505] "201537" "201538" "201539" "201540" ...</span></span>
<span><span class="co">##  $ plotID              : chr [1:3505] "BLAN_005" "BLAN_005" "BLAN_005" "BLAN_005" ...</span></span>
<span><span class="co">##  $ siteID              : chr [1:3505] "BLAN" "BLAN" "BLAN" "BLAN" ...</span></span>
<span><span class="co">##  $ nlcdClass           : chr [1:3505] "deciduousForest" "deciduousForest" "deciduousForest" "deciduousForest" ...</span></span>
<span><span class="co">##  $ decimalLatitude     : num [1:3505] 39.1 39.1 39.1 39.1 39.1 ...</span></span>
<span><span class="co">##  $ decimalLongitude    : num [1:3505] -78 -78 -78 -78 -78 ...</span></span>
<span><span class="co">##  $ elevation           : num [1:3505] 168 168 168 168 168 ...</span></span>
<span><span class="co">##  $ totalSampledArea    : num [1:3505] 162 NA NA NA 162 NA NA NA NA 164 ...</span></span>
<span><span class="co">##  $ amblyomma_americanum: num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ ixodes_scapularis   : num [1:3505] 2 NA NA NA 0 NA NA NA NA 0 ...</span></span>
<span><span class="co">##  $ time                : Date[1:3505], format: "2015-09-13" "2015-09-20" ...</span></span>
<span><span class="co">##  $ RHMin_precent       : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ RHMin_variance      : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ RHMax_precent       : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ RHMax_variance      : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ airTempMin_degC     : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ airTempMin_variance : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ airTempMax_degC     : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ airTempMax_variance : num [1:3505] NA NA NA NA NA NA NA NA NA NA ...</span></span>
<span><span class="co">##  $ soi                 : num [1:3505] -18.4 -17.9 -23.5 -28.4 -25.9 ...</span></span>
<span><span class="co">##  $ cum_sdd             : num [1:3505] 173 173 173 173 173 ...</span></span>
<span><span class="co">##  $ cum_gdd             : num [1:3505] 1129 1129 1129 1129 1129 ...</span></span></code></pre>
<p>For this exercise, we will use the <code>epiWeek</code> variable as
an index of seasonality, and we will only work with observations from a
few sampling plots (labelled in the <code>plotID</code> column):</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'SCBI_013'</span>,<span class="st">'SCBI_002'</span>,</span>
<span>             <span class="st">'SERC_001'</span>,<span class="st">'SERC_005'</span>,</span>
<span>             <span class="st">'SERC_006'</span>,<span class="st">'SERC_012'</span>,</span>
<span>             <span class="st">'BLAN_012'</span>,<span class="st">'BLAN_005'</span><span class="op">)</span></span></code></pre></div>
<p>Now we can select the target species we want (<em>I.
scapularis</em>), filter to the correct plot IDs and convert the
<code>epiWeek</code> variable from <code>character</code> to
<code>numeric</code>:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op">&lt;-</span> <span class="va">all_neon_tick_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">ixodes_scapularis</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">plotID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">plotIDs</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">epiWeek</span>, <span class="va">plotID</span>, <span class="va">target</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>epiWeek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">epiWeek</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now is the tricky part: we need to fill in missing observations with
<code>NA</code>s. The tick data are sparse in that field observers do
not go out and sample in each possible <code>epiWeek</code>. So there
are many particular weeks in which observations are not included in the
data. But we can use <code>expand.grid</code> again to take care of
this:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Create all possible combos of plotID, Year and epiWeek; </span></span>
<span>  <span class="co"># missing outcomes will be filled in as NA</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>plotID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">model_dat</span><span class="op">$</span><span class="va">plotID</span><span class="op">)</span>,</span>
<span>                               Year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">model_dat</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>,</span>
<span>                               epiWeek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">52</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  </span>
<span>  <span class="co"># left_join back to original data so plotID and siteID will</span></span>
<span>  <span class="co"># match up, in case you need the siteID for anything else later on</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">all_neon_tick_data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                     <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">siteID</span>, <span class="va">plotID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                     <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_dat</span></span></code></pre></div>
<pre><code><span><span class="co">## Joining, by = c("Year", "epiWeek", "plotID")</span></span>
<span><span class="co">## Joining, by = "plotID"</span></span></code></pre>
<p>Create the <code>series</code> variable needed for <code>mvgam</code>
modelling:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>series <span class="op">=</span> <span class="va">plotID</span>,</span>
<span>                y <span class="op">=</span> <span class="va">target</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>siteID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">siteID</span><span class="op">)</span>,</span>
<span>                series <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">target</span>, <span class="op">-</span><span class="va">plotID</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">epiWeek</span>, <span class="va">series</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_dat</span> </span></code></pre></div>
<p>Now create the <code>time</code> variable, which needs to track
<code>Year</code> and <code>epiWeek</code> for each unique series. The
<code>n</code> function from <code>dplyr</code> is often useful if
generating a <code>time</code> index for grouped dataframes:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_dat</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">series</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">Year</span>, <span class="va">epiWeek</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">model_dat</span></span></code></pre></div>
<p>Check factor levels for the <code>series</code>:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">model_dat</span><span class="op">$</span><span class="va">series</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "BLAN_005" "BLAN_012" "SCBI_002" "SCBI_013" "SERC_001" "SERC_005" "SERC_006"</span></span>
<span><span class="co">## [8] "SERC_012"</span></span></code></pre>
<p>This looks good, as does a more rigorous check using
<code>get_mvgam_priors</code>:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_mvgam_priors.html">get_mvgam_priors</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">model_dat</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    param_name param_length  param_info                                  prior</span></span>
<span><span class="co">## 1 (Intercept)            1 (Intercept) (Intercept) ~ student_t(3, -2.3, 2.5);</span></span>
<span><span class="co">##                example_change new_lowerbound new_upperbound</span></span>
<span><span class="co">## 1 (Intercept) ~ normal(0, 1);             NA             NA</span></span></code></pre>
<p>We can also set up a model in <code>mvgam</code> but use
<code>run_model = FALSE</code> to further ensure all of the necessary
steps for creating the modelling code and objects will run. It is
recommended that you use the <code>cmdstanr</code> backend if possible,
as the auto-formatting options available in this package are very useful
for checking the package-generated <code>Stan</code> code for any
inefficiencies that can be fixed to lead to sampling performance
improvements:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testmod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mvgam.html">mvgam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">epiWeek</span>, by <span class="op">=</span> <span class="va">series</span>, bs <span class="op">=</span> <span class="st">'cc'</span><span class="op">)</span> <span class="op">+</span></span>
<span>                   <span class="fu">s</span><span class="op">(</span><span class="va">series</span>, bs <span class="op">=</span> <span class="st">'re'</span><span class="op">)</span>,</span>
<span>                 trend_model <span class="op">=</span> <span class="st">'AR1'</span>,</span>
<span>                 data <span class="op">=</span> <span class="va">model_dat</span>,</span>
<span>                 backend <span class="op">=</span> <span class="st">'cmdstanr'</span>,</span>
<span>                 run_model <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>This call runs without issue, and the resulting object now contains
the model code and data objects that are needed to initiate
sampling:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">testmod</span><span class="op">$</span><span class="va">model_data</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## List of 25</span></span>
<span><span class="co">##  $ y           : num [1:416, 1:8] -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 ...</span></span>
<span><span class="co">##  $ n           : int 416</span></span>
<span><span class="co">##  $ X           : num [1:3328, 1:73] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:3328] "1" "2" "3" "4" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:73] "X.Intercept." "V2" "V3" "V4" ...</span></span>
<span><span class="co">##  $ S1          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ zero        : num [1:73] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ S2          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ S3          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ S4          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ S5          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ S6          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ S7          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ S8          : num [1:8, 1:8] 1.037 -0.416 0.419 0.117 0.188 ...</span></span>
<span><span class="co">##  $ p_coefs     : Named num 0.822</span></span>
<span><span class="co">##   ..- attr(*, "names")= chr "(Intercept)"</span></span>
<span><span class="co">##  $ p_taus      : num 192</span></span>
<span><span class="co">##  $ ytimes      : int [1:416, 1:8] 1 9 17 25 33 41 49 57 65 73 ...</span></span>
<span><span class="co">##  $ n_series    : int 8</span></span>
<span><span class="co">##  $ sp          : Named num [1:9] 10.82 14.59 35.75 14.32 2.07 ...</span></span>
<span><span class="co">##   ..- attr(*, "names")= chr [1:9] "s(epiWeek):seriesBLAN_005" "s(epiWeek):seriesBLAN_012" "s(epiWeek):seriesSCBI_002" "s(epiWeek):seriesSCBI_013" ...</span></span>
<span><span class="co">##  $ y_observed  : num [1:416, 1:8] 0 0 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">##  $ total_obs   : int 3328</span></span>
<span><span class="co">##  $ num_basis   : int 73</span></span>
<span><span class="co">##  $ n_sp        : num 9</span></span>
<span><span class="co">##  $ n_nonmissing: int 400</span></span>
<span><span class="co">##  $ obs_ind     : int [1:400] 89 93 98 101 115 118 121 124 127 130 ...</span></span>
<span><span class="co">##  $ flat_ys     : num [1:400] 2 0 0 0 0 0 0 25 36 14 ...</span></span>
<span><span class="co">##  $ flat_xs     : num [1:400, 1:73] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">##   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">##   .. ..$ : chr [1:400] "705" "737" "777" "801" ...</span></span>
<span><span class="co">##   .. ..$ : chr [1:73] "X.Intercept." "V2" "V3" "V4" ...</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/code.html">code</a></span><span class="op">(</span><span class="va">testmod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## // Stan model code generated by package mvgam</span></span>
<span><span class="co">## data {</span></span>
<span><span class="co">##   int&lt;lower=0&gt; total_obs; // total number of observations</span></span>
<span><span class="co">##   int&lt;lower=0&gt; n; // number of timepoints per series</span></span>
<span><span class="co">##   int&lt;lower=0&gt; n_sp; // number of smoothing parameters</span></span>
<span><span class="co">##   int&lt;lower=0&gt; n_series; // number of series</span></span>
<span><span class="co">##   int&lt;lower=0&gt; num_basis; // total number of basis coefficients</span></span>
<span><span class="co">##   vector[num_basis] zero; // prior locations for basis coefficients</span></span>
<span><span class="co">##   matrix[total_obs, num_basis] X; // mgcv GAM design matrix</span></span>
<span><span class="co">##   array[n, n_series] int&lt;lower=0&gt; ytimes; // time-ordered matrix (which col in X belongs to each [time, series] observation?)</span></span>
<span><span class="co">##   matrix[8, 8] S1; // mgcv smooth penalty matrix S1</span></span>
<span><span class="co">##   matrix[8, 8] S2; // mgcv smooth penalty matrix S2</span></span>
<span><span class="co">##   matrix[8, 8] S3; // mgcv smooth penalty matrix S3</span></span>
<span><span class="co">##   matrix[8, 8] S4; // mgcv smooth penalty matrix S4</span></span>
<span><span class="co">##   matrix[8, 8] S5; // mgcv smooth penalty matrix S5</span></span>
<span><span class="co">##   matrix[8, 8] S6; // mgcv smooth penalty matrix S6</span></span>
<span><span class="co">##   matrix[8, 8] S7; // mgcv smooth penalty matrix S7</span></span>
<span><span class="co">##   matrix[8, 8] S8; // mgcv smooth penalty matrix S8</span></span>
<span><span class="co">##   int&lt;lower=0&gt; n_nonmissing; // number of nonmissing observations</span></span>
<span><span class="co">##   array[n_nonmissing] int&lt;lower=0&gt; flat_ys; // flattened nonmissing observations</span></span>
<span><span class="co">##   matrix[n_nonmissing, num_basis] flat_xs; // X values for nonmissing observations</span></span>
<span><span class="co">##   array[n_nonmissing] int&lt;lower=0&gt; obs_ind; // indices of nonmissing observations</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## parameters {</span></span>
<span><span class="co">##   // raw basis coefficients</span></span>
<span><span class="co">##   vector[num_basis] b_raw;</span></span>
<span><span class="co">##   // random effect variances</span></span>
<span><span class="co">##   vector&lt;lower=0&gt;[1] sigma_raw;</span></span>
<span><span class="co">##   // random effect means</span></span>
<span><span class="co">##   vector[1] mu_raw;</span></span>
<span><span class="co">##   // latent trend AR1 terms</span></span>
<span><span class="co">##   vector&lt;lower=-1.5, upper=1.5&gt;[n_series] ar1;</span></span>
<span><span class="co">##   // latent trend variance parameters</span></span>
<span><span class="co">##   vector&lt;lower=0&gt;[n_series] sigma;</span></span>
<span><span class="co">##   // latent trends</span></span>
<span><span class="co">##   matrix[n, n_series] trend;</span></span>
<span><span class="co">##   // smoothing parameters</span></span>
<span><span class="co">##   vector&lt;lower=0&gt;[n_sp] lambda;</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## transformed parameters {</span></span>
<span><span class="co">##   // basis coefficients</span></span>
<span><span class="co">##   vector[num_basis] b;</span></span>
<span><span class="co">##   b[1 : 65] = b_raw[1 : 65];</span></span>
<span><span class="co">##   b[66 : 73] = mu_raw[1] + b_raw[66 : 73] * sigma_raw[1];</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## model {</span></span>
<span><span class="co">##   // prior for random effect population variances</span></span>
<span><span class="co">##   sigma_raw ~ student_t(3, 0, 2.5);</span></span>
<span><span class="co">##   // prior for random effect population means</span></span>
<span><span class="co">##   mu_raw ~ std_normal();</span></span>
<span><span class="co">##   // prior for (Intercept)...</span></span>
<span><span class="co">##   b_raw[1] ~ student_t(3, -2.3, 2.5);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesBLAN_005...</span></span>
<span><span class="co">##   b_raw[2 : 9] ~ multi_normal_prec(zero[2 : 9], S1[1 : 8, 1 : 8] * lambda[1]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesBLAN_012...</span></span>
<span><span class="co">##   b_raw[10 : 17] ~ multi_normal_prec(zero[10 : 17],</span></span>
<span><span class="co">##                                      S2[1 : 8, 1 : 8] * lambda[2]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesSCBI_002...</span></span>
<span><span class="co">##   b_raw[18 : 25] ~ multi_normal_prec(zero[18 : 25],</span></span>
<span><span class="co">##                                      S3[1 : 8, 1 : 8] * lambda[3]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesSCBI_013...</span></span>
<span><span class="co">##   b_raw[26 : 33] ~ multi_normal_prec(zero[26 : 33],</span></span>
<span><span class="co">##                                      S4[1 : 8, 1 : 8] * lambda[4]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesSERC_001...</span></span>
<span><span class="co">##   b_raw[34 : 41] ~ multi_normal_prec(zero[34 : 41],</span></span>
<span><span class="co">##                                      S5[1 : 8, 1 : 8] * lambda[5]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesSERC_005...</span></span>
<span><span class="co">##   b_raw[42 : 49] ~ multi_normal_prec(zero[42 : 49],</span></span>
<span><span class="co">##                                      S6[1 : 8, 1 : 8] * lambda[6]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesSERC_006...</span></span>
<span><span class="co">##   b_raw[50 : 57] ~ multi_normal_prec(zero[50 : 57],</span></span>
<span><span class="co">##                                      S7[1 : 8, 1 : 8] * lambda[7]);</span></span>
<span><span class="co">##   // prior for s(epiWeek):seriesSERC_012...</span></span>
<span><span class="co">##   b_raw[58 : 65] ~ multi_normal_prec(zero[58 : 65],</span></span>
<span><span class="co">##                                      S8[1 : 8, 1 : 8] * lambda[8]);</span></span>
<span><span class="co">##   // prior (non-centred) for s(series)...</span></span>
<span><span class="co">##   b_raw[66 : 73] ~ std_normal();</span></span>
<span><span class="co">##   // priors for AR parameters</span></span>
<span><span class="co">##   ar1 ~ std_normal();</span></span>
<span><span class="co">##   // priors for smoothing parameters</span></span>
<span><span class="co">##   lambda ~ normal(10, 25);</span></span>
<span><span class="co">##   // priors for latent trend variance parameters</span></span>
<span><span class="co">##   sigma ~ student_t(3, 0, 2.5);</span></span>
<span><span class="co">##   // trend estimates</span></span>
<span><span class="co">##   trend[1, 1 : n_series] ~ normal(0, sigma);</span></span>
<span><span class="co">##   for (s in 1 : n_series) {</span></span>
<span><span class="co">##     trend[2 : n, s] ~ normal(ar1[s] * trend[1 : (n - 1), s], sigma[s]);</span></span>
<span><span class="co">##   }</span></span>
<span><span class="co">##   {</span></span>
<span><span class="co">##     // likelihood functions</span></span>
<span><span class="co">##     vector[n_nonmissing] flat_trends;</span></span>
<span><span class="co">##     flat_trends = to_vector(trend)[obs_ind];</span></span>
<span><span class="co">##     flat_ys ~ poisson_log_glm(append_col(flat_xs, flat_trends), 0.0,</span></span>
<span><span class="co">##                               append_row(b, 1.0));</span></span>
<span><span class="co">##   }</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## generated quantities {</span></span>
<span><span class="co">##   vector[total_obs] eta;</span></span>
<span><span class="co">##   matrix[n, n_series] mus;</span></span>
<span><span class="co">##   vector[n_sp] rho;</span></span>
<span><span class="co">##   vector[n_series] tau;</span></span>
<span><span class="co">##   array[n, n_series] int ypred;</span></span>
<span><span class="co">##   rho = log(lambda);</span></span>
<span><span class="co">##   for (s in 1 : n_series) {</span></span>
<span><span class="co">##     tau[s] = pow(sigma[s], -2.0);</span></span>
<span><span class="co">##   }</span></span>
<span><span class="co">##   // posterior predictions</span></span>
<span><span class="co">##   eta = X * b;</span></span>
<span><span class="co">##   for (s in 1 : n_series) {</span></span>
<span><span class="co">##     mus[1 : n, s] = eta[ytimes[1 : n, s]] + trend[1 : n, s];</span></span>
<span><span class="co">##     ypred[1 : n, s] = poisson_log_rng(mus[1 : n, s]);</span></span>
<span><span class="co">##   }</span></span>
<span><span class="co">## }</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://researchers.uq.edu.au/researcher/15140" class="external-link">Nicholas J Clark</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
